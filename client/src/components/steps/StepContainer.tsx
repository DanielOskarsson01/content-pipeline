import type { ReactNode } from 'react';
import { usePipelineStore } from '../../stores/pipelineStore';

export type StepStatus = 'pending' | 'active' | 'running' | 'completed' | 'skipped' | 'error';

interface StepContainerProps {
  step: number;
  title: string;
  description: string;
  status?: StepStatus;
  resultSummary?: string;
  children: ReactNode;
}

function getStepNumberClass(status: StepStatus): string {
  switch (status) {
    case 'active':
      return 'bg-sky-600 text-white';
    case 'completed':
      return 'bg-green-500 text-white';
    case 'running':
      return 'bg-amber-500 text-white animate-pulse';
    case 'error':
      return 'bg-red-500 text-white';
    case 'skipped':
      return 'bg-gray-300 text-gray-500';
    default:
      return 'bg-gray-200 text-gray-500';
  }
}

function getStatusBadgeClass(status: StepStatus): string {
  switch (status) {
    case 'active':
      return 'bg-sky-100 text-sky-700';
    case 'completed':
      return 'bg-green-100 text-green-700';
    case 'running':
      return 'bg-amber-100 text-amber-700';
    case 'error':
      return 'bg-red-100 text-red-700';
    case 'skipped':
      return 'bg-gray-100 text-gray-500';
    default:
      return 'bg-gray-100 text-gray-500';
  }
}

function getContainerClass(status: StepStatus): string {
  const base = 'rounded-lg border overflow-hidden transition-all';

  if (status === 'active') {
    return `${base} bg-white border-sky-500 shadow-md ring-1 ring-sky-200`;
  }
  if (status === 'completed') {
    return `${base} bg-white border-gray-200`;
  }
  if (status === 'skipped') {
    return `${base} bg-gray-50 border-gray-200 opacity-40`;
  }
  // pending
  return `${base} bg-gray-50 border-gray-200 opacity-60`;
}

export function StepContainer({
  step,
  title,
  description,
  status = 'pending',
  resultSummary,
  children,
}: StepContainerProps) {
  const { expandedStep, toggleStep } = usePipelineStore();
  const isExpanded = expandedStep === step;

  return (
    <div className={getContainerClass(status)}>
      {/* Step Header */}
      <div
        className="flex items-center gap-3 px-4 py-3 cursor-pointer select-none"
        onClick={() => toggleStep(step)}
      >
        {/* Step number circle */}
        <div
          className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0 ${getStepNumberClass(status)}`}
        >
          {status === 'completed' ? (
            <span className="text-sm">✓</span>
          ) : (
            <span>{step}</span>
          )}
        </div>

        {/* Step name + description */}
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            <span
              className={`text-sm font-medium ${
                status === 'active'
                  ? 'text-gray-900'
                  : status === 'completed'
                  ? 'text-gray-700'
                  : 'text-gray-400'
              }`}
            >
              {title}
            </span>
            {status === 'skipped' && (
              <span className="text-xs text-gray-400 italic">skipped</span>
            )}
          </div>
          <p
            className={`text-xs truncate ${
              status === 'active' ? 'text-gray-500' : 'text-gray-300'
            }`}
          >
            {description}
          </p>
        </div>

        {/* Status + controls */}
        <div
          className={`flex items-center gap-2 flex-shrink-0 ${
            status === 'active' || status === 'completed' ? '' : 'opacity-50'
          }`}
        >
          {resultSummary && (
            <span className="text-xs text-gray-500">{resultSummary}</span>
          )}
          <span
            className={`text-xs px-2 py-0.5 rounded-full ${getStatusBadgeClass(status)}`}
          >
            {status}
          </span>
          <span className="text-gray-400 text-sm">
            {isExpanded ? '▲' : '▼'}
          </span>
        </div>
      </div>

      {/* Step Body (expanded) */}
      {isExpanded && (
        <div className="border-t border-gray-200">
          <div className="p-4">{children}</div>
        </div>
      )}
    </div>
  );
}
