<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Pipeline</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' }
          }
        }
      }
    }
  </script>
  <style>
    [x-cloak] { display: none !important; }

    /* Slide-in panel animation */
    .slide-panel {
      transform: translateX(-100%);
      transition: transform 0.3s ease-out;
    }
    .slide-panel.open {
      transform: translateX(0);
    }

    /* Backdrop fade */
    .panel-backdrop {
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }
    .panel-backdrop.open {
      opacity: 1;
    }

    /* Submodule state indicators */
    .submodule-card {
      transition: all 0.2s ease-out;
    }
    .submodule-card.approved {
      border-color: #22c55e;
      background: linear-gradient(to right, #f0fdf4 0%, white 100%);
    }
    .submodule-card.has-results {
      border-color: #3b82f6;
      background: linear-gradient(to right, #eff6ff 0%, white 100%);
    }
    .submodule-card.running {
      border-color: #f59e0b;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">

  <div x-data="app()" x-init="init()" x-cloak>

    <!-- Submodule Overlay Panel (New Flow: RUN â†’ SEE RESULTS â†’ APPROVE) -->
    <div x-show="submodulePanelOpen" class="fixed inset-0 z-50" @keydown.escape.window="closeSubmodulePanel()">
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black/30 panel-backdrop"
           :class="submodulePanelOpen ? 'open' : ''"
           @click="closeSubmodulePanel()"></div>

      <!-- Panel -->
      <div class="fixed inset-y-0 left-0 w-full max-w-lg bg-white shadow-2xl slide-panel flex flex-col"
           :class="submodulePanelOpen ? 'open' : ''">

        <!-- Panel Header -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-gray-50">
          <div class="flex items-center gap-2">
            <button @click="closeSubmodulePanel()" class="text-gray-400 hover:text-gray-600">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <div>
              <h3 class="text-sm font-semibold text-gray-900" x-text="activeSubmodule?.name || 'Submodule'"></h3>
              <p class="text-[10px] text-gray-500" x-text="activeSubmodule?.description || ''"></p>
            </div>
          </div>
          <button @click="closeSubmodulePanel()" class="p-1 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <!-- Panel Content -->
        <div class="flex-1 overflow-hidden p-4 flex flex-col">

          <!-- State: IDLE (before run) -->
          <div x-show="submoduleState === 'idle' || submoduleState === 'ready'">

            <!-- Input Data Section -->
            <div class="mb-4">
              <p class="text-xs text-gray-600 font-medium mb-2 uppercase">Input data</p>
              <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">

                <!-- Show existing entity context if available -->
                <div x-show="entityContext && entityContext.entities?.length > 0" class="mb-3">
                  <div class="flex items-center gap-2 text-green-700 mb-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                    <span class="text-xs font-medium" x-text="entityContext.entities.length + ' entities loaded'"></span>
                  </div>
                  <p class="text-[10px] text-gray-500 mb-2" x-text="(entityContext.stats?.by_column?.website || 0) + ' have website (required for this submodule)'"></p>
                  <div class="flex gap-2">
                    <button @click="useExistingEntities()" class="text-xs bg-brand-600 hover:bg-brand-700 text-white px-3 py-1.5 rounded">Use these</button>
                    <button @click="showUploadForm = true" class="text-xs text-gray-600 hover:text-gray-800 px-3 py-1.5 rounded border border-gray-300 hover:border-gray-400">Upload different</button>
                  </div>
                </div>

                <!-- Upload form (shown if no context or user wants to upload different) -->
                <div x-show="!entityContext || !entityContext.entities?.length || showUploadForm">
                  <div class="mb-3">
                    <label class="block text-xs text-gray-600 mb-1">Paste URLs (one per line)</label>
                    <textarea x-model="submoduleInputUrls" rows="3" placeholder="https://betsson.com&#10;https://evolution.com&#10;https://leovegas.com"
                      class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm font-mono focus:outline-none focus:border-brand-500"></textarea>
                    <button x-show="submoduleInputUrls.trim().length > 0"
                            @click="saveUrlsAsEntities()"
                            class="mt-2 w-full bg-brand-600 hover:bg-brand-700 text-white py-2 rounded text-sm font-medium">
                      Save URLs
                    </button>
                  </div>
                  <div class="text-center text-[10px] text-gray-400 mb-3">â€” or â€”</div>
                  <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-brand-400 transition-colors cursor-pointer"
                       @click="$refs.csvUploadInput.click()"
                       @dragover.prevent="$event.target.classList.add('border-brand-500')"
                       @dragleave="$event.target.classList.remove('border-brand-500')"
                       @drop.prevent="handleCsvDrop($event)">
                    <input type="file" x-ref="csvUploadInput" accept=".csv" class="hidden" @change="handleCsvUpload($event)">
                    <p class="text-xs text-gray-500">Drop CSV here or click to browse</p>
                  </div>
                  <!-- CSV Format Help -->
                  <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                    <p class="text-[10px] text-blue-800 font-medium mb-1">CSV Format:</p>
                    <p class="text-[10px] text-blue-700 font-mono">entity_name,website,linkedin,youtube</p>
                    <p class="text-[10px] text-blue-600 mt-1">Required: entity_name. Optional: website, linkedin, youtube, twitter, category</p>
                  </div>
                  <div x-show="uploadedCsvInfo" class="mt-2 flex items-center gap-2 text-green-700 text-xs">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                    <span x-text="uploadedCsvInfo"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Advanced Options (collapsible) -->
            <div class="mb-4">
              <button @click="showAdvancedOptions = !showAdvancedOptions"
                      class="flex items-center gap-2 text-xs text-gray-600 hover:text-gray-800">
                <span x-text="showAdvancedOptions ? 'â–¼' : 'â–¶'"></span>
                <span>Advanced options</span>
              </button>
              <div x-show="showAdvancedOptions" x-transition class="mt-3 bg-gray-50 rounded-lg border border-gray-200 p-4">
                <template x-if="activeSubmodule?.id === 'sitemap'">
                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs text-gray-600 mb-1">Sitemap location</label>
                      <select x-model="submoduleOptions.sitemap_location" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm">
                        <option value="auto">Auto-detect</option>
                        <option value="custom">Custom URL</option>
                      </select>
                    </div>
                    <div class="flex items-center gap-2">
                      <input type="checkbox" x-model="submoduleOptions.include_nested" id="includeNested" class="rounded border-gray-300 text-brand-600">
                      <label for="includeNested" class="text-xs text-gray-700">Include nested sitemaps</label>
                    </div>
                  </div>
                </template>
                <template x-if="activeSubmodule?.id === 'navigation'">
                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs text-gray-600 mb-1">Scan areas</label>
                      <div class="flex flex-wrap gap-2">
                        <label class="flex items-center gap-1 text-xs"><input type="checkbox" x-model="submoduleOptions.scan_header" class="rounded border-gray-300 text-brand-600"> Header</label>
                        <label class="flex items-center gap-1 text-xs"><input type="checkbox" x-model="submoduleOptions.scan_footer" class="rounded border-gray-300 text-brand-600"> Footer</label>
                        <label class="flex items-center gap-1 text-xs"><input type="checkbox" x-model="submoduleOptions.scan_sidebar" class="rounded border-gray-300 text-brand-600"> Sidebar</label>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <input type="checkbox" x-model="submoduleOptions.follow_dropdowns" id="followDropdowns" class="rounded border-gray-300 text-brand-600">
                      <label for="followDropdowns" class="text-xs text-gray-700">Follow dropdown menus</label>
                    </div>
                  </div>
                </template>
                <template x-if="activeSubmodule?.id === 'seed-expansion'">
                  <div class="space-y-3">
                    <div class="flex items-center gap-2">
                      <input type="checkbox" x-model="submoduleOptions.same_domain" id="sameDomain" class="rounded border-gray-300 text-brand-600">
                      <label for="sameDomain" class="text-xs text-gray-700">Same domain only</label>
                    </div>
                    <button @click="useCommonSeeds()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded border border-gray-300">
                      Use common seeds (/about, /products, /news...)
                    </button>
                  </div>
                </template>
              </div>
            </div>

          </div>

          <!-- State: RUNNING -->
          <div x-show="submoduleState === 'running'" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-brand-600 mb-4"></div>
            <p class="text-sm text-gray-700">Running <span x-text="activeSubmodule?.name"></span>...</p>
            <p class="text-xs text-gray-500 mt-1">Processing entities</p>
          </div>

          <!-- State: COMPLETED (show "See Results" prompt) -->
          <div x-show="submoduleState === 'completed'" class="text-center py-8">
            <div class="flex items-center justify-center gap-2 text-green-600 mb-4">
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
            </div>
            <p class="text-sm font-medium text-gray-900" x-text="'Run complete: ' + (submoduleRunResult?.result_count || 0) + ' URLs found'"></p>
            <p x-show="submoduleRunResult?.errors?.length > 0" class="text-xs text-yellow-600 mt-1" x-text="submoduleRunResult.errors.length + ' entity/entities had errors'"></p>
          </div>

          <!-- State: VIEWING (showing results) -->
          <div x-show="submoduleState === 'viewing'" class="flex flex-col h-full">
            <!-- Results by Entity (compact) -->
            <div class="mb-3 flex-shrink-0">
              <div class="flex items-center justify-between mb-2">
                <p class="text-xs text-gray-600 font-medium uppercase">Results by entity</p>
                <span class="text-xs text-gray-500" x-text="(submoduleRunResult?.result_count || 0) + ' total URLs'"></span>
              </div>
              <div class="space-y-1 max-h-32 overflow-y-auto">
                <template x-for="(entity, idx) in submoduleRunResult?.entities || []" :key="idx">
                  <div class="bg-white rounded border px-3 py-2"
                       :class="entity.error ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200'">
                    <div class="flex items-center justify-between">
                      <span class="text-xs font-medium text-gray-800" x-text="entity.name"></span>
                      <span x-show="!entity.error" class="text-xs text-green-600" x-text="entity.url_count + ' URLs'"></span>
                      <span x-show="entity.error" class="text-xs text-yellow-600" x-text="entity.error"></span>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- All Discovered URLs (fills remaining space) -->
            <div class="flex-1 flex flex-col min-h-0">
              <p class="text-xs text-gray-600 font-medium uppercase mb-2 flex-shrink-0">Discovered URLs</p>
              <div class="bg-gray-50 rounded-lg border border-gray-200 p-3 flex-1 overflow-y-auto">
                <template x-for="(url, idx) in (submoduleRunResult?.all_urls || [])" :key="idx">
                  <a :href="url" target="_blank" rel="noopener"
                     class="block text-[10px] text-blue-600 hover:text-blue-800 hover:underline py-0.5 truncate"
                     x-text="url"></a>
                </template>
                <p x-show="!submoduleRunResult?.all_urls?.length" class="text-[10px] text-gray-400">No URLs discovered</p>
              </div>
            </div>
          </div>

          <!-- State: APPROVED (show results with approval badge) -->
          <div x-show="submoduleState === 'approved'" class="flex flex-col h-full">
            <!-- Approval Badge (compact) -->
            <div class="mb-3 p-2 bg-green-50 rounded-lg border border-green-200 flex-shrink-0">
              <div class="flex items-center gap-2 text-green-700">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                <span class="text-sm font-medium">Approved</span>
                <span class="text-xs text-green-600" x-text="'(' + (submoduleRunResult?.result_count || 0) + ' URLs)'"></span>
              </div>
            </div>

            <!-- Results by Entity (compact) -->
            <div class="mb-3 flex-shrink-0" x-show="submoduleRunResult?.entities?.length > 0">
              <div class="flex items-center justify-between mb-2">
                <p class="text-xs text-gray-600 font-medium uppercase">Results by entity</p>
                <span class="text-xs text-gray-500" x-text="(submoduleRunResult?.result_count || 0) + ' total URLs'"></span>
              </div>
              <div class="space-y-1 max-h-32 overflow-y-auto">
                <template x-for="(entity, idx) in submoduleRunResult?.entities || []" :key="idx">
                  <div class="bg-white rounded border border-gray-200 px-3 py-2">
                    <div class="flex items-center justify-between">
                      <span class="text-xs font-medium text-gray-800" x-text="entity.name"></span>
                      <span class="text-xs text-green-600" x-text="entity.url_count + ' URLs'"></span>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- All Discovered URLs (fills remaining space) -->
            <div class="flex-1 flex flex-col min-h-0" x-show="submoduleRunResult?.all_urls?.length > 0">
              <p class="text-xs text-gray-600 font-medium uppercase mb-2 flex-shrink-0">Discovered URLs</p>
              <div class="bg-gray-50 rounded-lg border border-gray-200 p-3 flex-1 overflow-y-auto">
                <template x-for="(url, idx) in (submoduleRunResult?.all_urls || [])" :key="idx">
                  <a :href="url" target="_blank" rel="noopener"
                     class="block text-[10px] text-blue-600 hover:text-blue-800 hover:underline py-0.5 truncate"
                     x-text="url"></a>
                </template>
              </div>
            </div>

            <!-- Run Again Option -->
            <div class="mt-3 pt-3 border-t border-gray-200 flex-shrink-0">
              <button @click="submoduleState = 'idle'; submoduleRunResult = null; activeSubmodule.status = 'pending'; activeSubmodule.result_count = 0; activeSubmodule.runResult = null;"
                      class="text-xs text-gray-500 hover:text-gray-700 underline">
                Run again with different input
              </button>
            </div>
          </div>

        </div>

        <!-- Panel Footer with state-based buttons -->
        <div class="border-t border-gray-200 px-4 py-3 bg-gray-50">
          <div class="flex items-center justify-end gap-2">

            <!-- IDLE/READY: Show RUN button -->
            <template x-if="submoduleState === 'idle' || submoduleState === 'ready'">
              <button @click="runActiveSubmodule()"
                      :disabled="!canRunSubmodule()"
                      :class="canRunSubmodule() ? 'bg-brand-600 hover:bg-brand-700' : 'bg-gray-300 cursor-not-allowed'"
                      class="text-white px-6 py-2 rounded text-sm font-medium">
                RUN TASK
              </button>
            </template>

            <!-- RUNNING: Show loading state -->
            <template x-if="submoduleState === 'running'">
              <button disabled class="bg-gray-300 text-white px-6 py-2 rounded text-sm font-medium cursor-not-allowed">
                Running...
              </button>
            </template>

            <!-- COMPLETED: Show SEE RESULTS button -->
            <template x-if="submoduleState === 'completed'">
              <button @click="submoduleState = 'viewing'" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded text-sm font-medium">
                SEE RESULTS
              </button>
            </template>

            <!-- VIEWING: Show APPROVE button -->
            <template x-if="submoduleState === 'viewing'">
              <div class="flex gap-2">
                <button @click="rejectSubmoduleRun()" class="text-red-600 hover:text-red-800 px-4 py-2 rounded text-sm border border-red-200 hover:border-red-300">
                  Reject
                </button>
                <button @click="approveSubmoduleRun()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded text-sm font-medium">
                  APPROVE
                </button>
              </div>
            </template>

            <!-- APPROVED: Show Done button -->
            <template x-if="submoduleState === 'approved'">
              <button @click="closeSubmodulePanel()" class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded text-sm font-medium">
                Done
              </button>
            </template>

          </div>
        </div>
      </div>
    </div>

    <!-- Legacy Results Panel (kept for backward compatibility) -->
    <div x-show="resultsPanelOpen" class="fixed inset-0 z-50" @keydown.escape.window="resultsPanelOpen = false">
      <!-- Backdrop -->
      <div class="fixed inset-0 bg-black/30 panel-backdrop"
           :class="resultsPanelOpen ? 'open' : ''"
           @click="resultsPanelOpen = false"></div>

      <!-- Panel -->
      <div class="fixed inset-y-0 left-0 w-full max-w-md bg-white shadow-2xl slide-panel flex flex-col"
           :class="resultsPanelOpen ? 'open' : ''">

        <!-- Panel Header -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-gray-50">
          <div class="flex items-center gap-2">
            <span class="text-lg" x-text="resultsPanel?.icon || 'ðŸ“Š'"></span>
            <div>
              <h3 class="text-sm font-semibold text-gray-900" x-text="resultsPanel?.title || 'Results'"></h3>
              <p class="text-[10px] text-gray-500" x-text="resultsPanel?.subtitle || ''"></p>
            </div>
          </div>
          <button @click="resultsPanelOpen = false" class="p-1 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <!-- Panel Content -->
        <div class="flex-1 overflow-y-auto p-4">

          <!-- Status Badge -->
          <div class="flex items-center gap-2 mb-4">
            <span class="text-xs px-2 py-1 rounded-full"
                  :class="resultsPanel?.status === 'success' ? 'bg-green-100 text-green-700' :
                          resultsPanel?.status === 'warning' ? 'bg-yellow-100 text-yellow-700' :
                          resultsPanel?.status === 'error' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'"
                  x-text="resultsPanel?.status || 'pending'"></span>
            <span class="text-[10px] text-gray-400" x-text="resultsPanel?.timestamp || ''"></span>
          </div>

          <!-- Stats Grid -->
          <div x-show="resultsPanel?.stats" class="grid grid-cols-2 gap-3 mb-4">
            <template x-for="(stat, key) in resultsPanel?.stats || {}" :key="key">
              <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                <p class="text-xs text-gray-500 capitalize" x-text="key.replace(/_/g, ' ')"></p>
                <p class="text-lg font-semibold text-gray-900" x-text="stat"></p>
              </div>
            </template>
          </div>

          <!-- Results List -->
          <div x-show="resultsPanel?.items?.length > 0">
            <p class="text-xs text-gray-500 mb-2 font-medium uppercase">Details</p>
            <div class="space-y-2">
              <template x-for="(item, idx) in resultsPanel?.items || []" :key="idx">
                <div class="bg-white rounded border border-gray-200 p-3">
                  <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0 flex-1">
                      <p class="text-xs font-medium text-gray-800 truncate" x-text="item.title || item.url || item.name"></p>
                      <p x-show="item.description" class="text-[10px] text-gray-400 mt-0.5" x-text="item.description"></p>
                      <p x-show="item.url" class="text-[10px] text-blue-500 truncate mt-0.5" x-text="item.url"></p>
                    </div>
                    <span x-show="item.status"
                          class="text-[8px] px-1.5 py-0.5 rounded flex-shrink-0"
                          :class="item.status === 'pass' || item.status === 'success' ? 'bg-green-100 text-green-700' :
                                  item.status === 'fail' || item.status === 'error' ? 'bg-red-100 text-red-700' :
                                  'bg-gray-100 text-gray-600'"
                          x-text="item.status"></span>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Log/Output -->
          <div x-show="resultsPanel?.log">
            <p class="text-xs text-gray-500 mb-2 font-medium uppercase mt-4">Output Log</p>
            <pre class="bg-gray-900 text-green-400 rounded p-3 text-[10px] overflow-x-auto max-h-48" x-text="resultsPanel?.log"></pre>
          </div>

          <!-- Empty State -->
          <div x-show="!resultsPanel?.stats && !resultsPanel?.items?.length && !resultsPanel?.log"
               class="text-center py-8 text-gray-400">
            <p class="text-sm">No results yet</p>
            <p class="text-xs mt-1">Run this submodule to see results</p>
          </div>

        </div>

        <!-- Panel Footer -->
        <div class="border-t border-gray-200 px-4 py-3 bg-gray-50 flex items-center justify-between">
          <button class="text-xs text-gray-500 hover:text-gray-700">View full logs</button>
          <div class="flex items-center gap-2">
            <!-- Approve/Reject buttons for submodule runs -->
            <template x-if="currentSubmoduleRun && currentSubmoduleRun.status === 'completed'">
              <div class="flex items-center gap-2">
                <button @click="rejectSubmoduleResults()" class="text-xs text-red-600 hover:text-red-800 px-3 py-1.5 rounded border border-red-200 hover:border-red-300">Reject</button>
                <button @click="approveSubmoduleResults()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded text-xs font-medium">Approve</button>
              </div>
            </template>
            <!-- Approved badge -->
            <span x-show="currentSubmoduleRun && currentSubmoduleRun.status === 'approved'" class="text-xs text-green-600 bg-green-100 px-3 py-1.5 rounded">Approved</span>
            <!-- Close button (always shown) -->
            <button x-show="!currentSubmoduleRun || currentSubmoduleRun.status !== 'completed'" @click="resultsPanelOpen = false" class="bg-brand-600 hover:bg-brand-700 text-white px-4 py-1.5 rounded text-xs font-medium">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-3 shadow-sm">
      <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
          <h1 class="text-lg font-bold text-gray-900">Content Pipeline</h1>
          <span class="text-xs bg-brand-600 text-white px-2 py-0.5 rounded-full">v3.0</span>
        </div>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 text-xs text-gray-500 cursor-pointer select-none">
            <span :class="useMockData ? 'text-yellow-600' : 'text-gray-400'">Demo</span>
            <div class="relative">
              <input type="checkbox" x-model="useMockData" @change="init()" class="sr-only">
              <div :class="useMockData ? 'bg-yellow-500' : 'bg-brand-600'" class="w-8 h-4 rounded-full transition-colors"></div>
              <div :class="useMockData ? 'translate-x-0' : 'translate-x-4'" class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-transform shadow"></div>
            </div>
            <span :class="!useMockData ? 'text-brand-600' : 'text-gray-400'">Live</span>
          </label>
          <span x-show="useMockData" class="flex items-center gap-1 text-yellow-600 text-xs">
            <span class="w-1.5 h-1.5 bg-yellow-500 rounded-full"></span> Demo
          </span>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 px-6">
      <div class="max-w-7xl mx-auto flex gap-1">
        <template x-for="tab in tabs" :key="tab.id">
          <button @click="activeTab = tab.id; selectedProject = null"
            :class="activeTab === tab.id ? 'border-brand-500 text-brand-700' : 'border-transparent text-gray-500 hover:text-gray-700'"
            class="px-4 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap"
            x-text="tab.label">
          </button>
        </template>
      </div>
    </nav>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-6 py-6">

      <!-- ==================== PROJECTS TAB ==================== -->
      <div x-show="activeTab === 'projects'">

        <!-- PROJECT DETAIL: Accordion Pipeline View -->
        <div x-show="selectedProject || showPipelineAccordion">
          <div class="flex items-center gap-3 mb-2">
            <button @click="selectedProject = null; showPipelineAccordion = false" class="text-gray-500 hover:text-gray-900 text-sm">&larr; Back</button>
            <h2 class="text-lg font-semibold text-gray-900" x-text="selectedProject?.name || 'New Project'"></h2>
            <span x-show="selectedProject?.label" class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded border border-gray-200" x-text="selectedProject?.label"></span>
          </div>
          <p x-show="selectedProject?.description" class="text-sm text-gray-500 mb-6" x-text="selectedProject?.description"></p>

          <!-- 11-Step Accordion -->
          <div class="space-y-2">
            <template x-for="(step, i) in pipelineSteps" :key="i">
              <div class="rounded-lg border overflow-hidden transition-all"
                   :class="{
                     'bg-white border-brand-500 shadow-md ring-1 ring-brand-200': stepStates[i]?.status === 'active',
                     'bg-white border-gray-200': stepStates[i]?.status === 'completed',
                     'bg-gray-50 border-gray-200 opacity-40': stepStates[i]?.status === 'skipped',
                     'bg-gray-50 border-gray-200 opacity-60': stepStates[i]?.status === 'pending' && !isStepUnlocked(i),
                     'bg-white border-gray-200': stepStates[i]?.status === 'pending' && isStepUnlocked(i)
                   }">

                <!-- Step Header (always visible) -->
                <div class="flex items-center gap-3 px-4 py-3 cursor-pointer select-none"
                     @click="toggleStep(i)">
                  <!-- Step number -->
                  <div class="w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0"
                       :class="stepHeaderClass(stepStates[i]?.status)">
                    <span x-show="stepStates[i]?.status !== 'completed'" x-text="i"></span>
                    <span x-show="stepStates[i]?.status === 'completed'" class="text-sm">&#10003;</span>
                  </div>
                  <!-- Step name + description -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-medium" :class="stepStates[i]?.status === 'active' ? 'text-gray-900' : stepStates[i]?.status === 'completed' ? 'text-gray-700' : 'text-gray-400'" x-text="step.name"></span>
                      <span x-show="stepStates[i]?.status === 'skipped'" class="text-xs text-gray-400 italic">skipped</span>
                    </div>
                    <p class="text-xs truncate" :class="stepStates[i]?.status === 'active' ? 'text-gray-500' : 'text-gray-300'" x-text="step.description"></p>
                  </div>
                  <!-- Status + controls -->
                  <div class="flex items-center gap-2 flex-shrink-0" :class="stepStates[i]?.status === 'active' || stepStates[i]?.status === 'completed' ? '' : 'opacity-50'">
                    <span x-show="stepStates[i]?.resultSummary" class="text-xs text-gray-500" x-text="stepStates[i]?.resultSummary"></span>
                    <button x-show="!useMockData && currentRunId && (stepStates[i]?.status === 'completed' || stepStates[i]?.status === 'approved' || stepStates[i]?.status === 'awaiting_approval')"
                            @click.stop="openStageResultsPanel(i)"
                            class="text-xs text-brand-600 hover:text-brand-800 px-2 py-0.5 rounded border border-brand-200 hover:border-brand-400">
                      View Results
                    </button>
                    <span :class="stepStatusBadge(stepStates[i]?.status)" class="text-xs px-2 py-0.5 rounded-full" x-text="stepStates[i]?.status || 'pending'"></span>
                    <span class="text-gray-400 text-sm" x-text="expandedStep === i ? '&#9650;' : '&#9660;'"></span>
                  </div>
                </div>

                <!-- Step Body (expanded) -->
                <div x-show="expandedStep === i" x-transition class="border-t border-gray-200">

                  <!-- Step-specific workspace content -->
                  <div class="p-4" :class="{'opacity-40 pointer-events-none': !isStepUnlocked(i) && stepStates[i]?.status !== 'completed'}">

                    <!-- STEP 0: Project Setup -->
                    <div x-show="i === 0">
                      <div class="space-y-4">
                        <!-- Project Selection: New or Existing -->
                        <div class="flex items-center gap-6 mb-4">
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="projectMode" value="new" x-model="step0Mode" class="w-4 h-4 text-brand-600 border-gray-300 focus:ring-brand-500">
                            <span class="text-sm text-gray-700">New Project</span>
                          </label>
                          <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="projectMode" value="existing" x-model="step0Mode" class="w-4 h-4 text-brand-600 border-gray-300 focus:ring-brand-500">
                            <span class="text-sm text-gray-700">Existing Project</span>
                          </label>
                        </div>

                        <!-- New Project Form -->
                        <div x-show="step0Mode === 'new'" class="space-y-4">
                          <div>
                            <label class="block text-xs text-gray-600 mb-1 font-medium">Project Name <span class="text-red-500">*</span></label>
                            <input x-model="step0NewProjectName" type="text" placeholder="e.g. Nordic Operators Q1 2026"
                              class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                          </div>

                          <div>
                            <label class="block text-xs text-gray-600 mb-1 font-medium">Description</label>
                            <textarea x-model="step0ProjectDescription" rows="2" placeholder="Brief description of this project's purpose..."
                              class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"></textarea>
                          </div>

                          <div>
                            <label class="block text-xs text-gray-600 mb-1 font-medium">Template</label>
                            <select x-model="step0SelectedTemplateId"
                              class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                              <option value="">None (start from scratch)</option>
                              <template x-for="tpl in templates" :key="tpl.id">
                                <option :value="tpl.id" x-text="tpl.name + ' (' + tpl.stages.length + ' steps)'"></option>
                              </template>
                            </select>
                            <p class="text-[10px] text-gray-400 mt-1">Templates pre-configure step settings for common workflows</p>
                          </div>

                          <button @click="createAndSelectProject()"
                            :disabled="!step0NewProjectName.trim()"
                            :class="step0NewProjectName.trim() ? 'bg-brand-600 hover:bg-brand-700' : 'bg-gray-300 cursor-not-allowed'"
                            class="w-full text-white px-4 py-2.5 rounded-lg text-sm font-medium transition-colors">
                            Create Project
                          </button>
                        </div>

                        <!-- Existing Project Dropdown -->
                        <div x-show="step0Mode === 'existing'" class="space-y-4">
                          <div>
                            <label class="block text-xs text-gray-600 mb-1 font-medium">Select Project</label>
                            <select x-model="step0SelectedProjectId" @change="selectProjectById(step0SelectedProjectId)"
                              class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 text-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500">
                              <option value="">-- Choose a project --</option>
                              <template x-for="p in projects.filter(p => p.status !== 'archived')" :key="p.id">
                                <option :value="p.id" x-text="p.name + ' (' + (p.input_count || 0) + ' items)'"></option>
                              </template>
                            </select>
                          </div>
                          <p class="text-[10px] text-gray-400">Continue working on an existing project</p>
                        </div>

                        <!-- Current Project Info (shown when a project is selected) -->
                        <div x-show="selectedProject" class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
                          <div class="flex items-center justify-between">
                            <div>
                              <p class="text-sm font-medium text-green-800">Active Project: <span x-text="selectedProject?.name"></span></p>
                              <p class="text-xs text-green-600 mt-1" x-text="(selectedProject?.input_count || 0) + ' items â€¢ ' + (selectedProject?.status || 'created')"></p>
                              <p x-show="selectedProject?.description" class="text-xs text-gray-600 mt-1" x-text="selectedProject?.description"></p>
                            </div>
                            <div class="flex items-center gap-2">
                              <span class="text-green-500 text-xl">âœ“</span>
                            </div>
                          </div>
                        </div>

                        <!-- No Project Selected Warning -->
                        <div x-show="!selectedProject" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4">
                          <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                            <p class="text-sm text-yellow-700">Create or select a project above to continue to the next steps.</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- STEP 1: Discovery (Category Cards with Submodules) -->
                    <div x-show="i === 1">
                      <div class="bg-blue-50 rounded-lg p-3 border border-blue-200 mb-4">
                        <p class="text-xs text-blue-700 font-medium mb-1">URL Discovery</p>
                        <p class="text-xs text-gray-600">Select source categories and run submodules to discover URLs. Each submodule can be run, reviewed, and approved independently.</p>
                      </div>

                      <!-- Source Category Cards -->
                      <p class="text-xs text-gray-500 mb-3 font-medium uppercase">Source Categories</p>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <template x-for="(cat, catKey) in discoveryCategories" :key="catKey">
                          <div class="rounded-lg border-2 transition-all cursor-pointer submodule-card"
                               :class="{
                                 'border-brand-400 bg-white shadow-md': cat.expanded,
                                 'border-gray-200 bg-gray-50 hover:border-gray-300': !cat.expanded && !cat.enabled,
                                 'border-brand-200 bg-white': !cat.expanded && cat.enabled
                               }"
                               @click="toggleDiscoveryCategory(catKey)">
                            <div class="p-4">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-2xl" x-text="cat.icon"></span>
                                <button @click.stop="cat.enabled = !cat.enabled"
                                        class="w-10 h-5 rounded-full relative transition-colors"
                                        :class="cat.enabled ? 'bg-brand-500' : 'bg-gray-300'">
                                  <span class="absolute top-0.5 w-4 h-4 rounded-full bg-white shadow transition-all"
                                        :class="cat.enabled ? 'right-0.5' : 'left-0.5'"></span>
                                </button>
                              </div>
                              <p class="text-sm font-semibold text-gray-800" x-text="cat.label"></p>
                              <p class="text-[10px] text-gray-500 mt-1">
                                <span x-text="getApprovedSubmoduleCount(cat) + '/' + cat.submodules.length"></span> approved
                                <span x-show="getCategoryUrlCount(cat) > 0" class="text-green-600 ml-1" x-text="'â€¢ ' + getCategoryUrlCount(cat) + ' URLs'"></span>
                              </p>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Expanded Category: Submodule List -->
                      <template x-for="(cat, catKey) in discoveryCategories" :key="'sub-' + catKey">
                        <div x-show="cat.expanded" x-transition class="mb-6">
                          <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                            <!-- Category Header -->
                            <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b border-gray-200">
                              <div class="flex items-center gap-2">
                                <span class="text-xl" x-text="cat.icon"></span>
                                <div>
                                  <h4 class="text-sm font-semibold text-gray-800" x-text="cat.label + ' Submodules'"></h4>
                                  <p class="text-[10px] text-gray-500" x-text="cat.description"></p>
                                </div>
                              </div>
                              <button @click="cat.expanded = false" class="text-gray-400 hover:text-gray-600 p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                              </button>
                            </div>

                            <!-- Submodule Cards -->
                            <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                              <template x-for="sub in cat.submodules" :key="sub.id">
                                <div class="rounded-lg border-2 p-4 transition-all cursor-pointer submodule-card hover:shadow-md"
                                     :class="{
                                       'approved border-green-400 bg-green-50': sub.status === 'approved',
                                       'has-results border-blue-400 bg-blue-50': sub.status === 'has_results',
                                       'running border-yellow-400': sub.status === 'running',
                                       'border-gray-200 bg-white hover:border-brand-300': sub.status === 'pending' || !sub.status
                                     }"
                                     @click="openSubmodule(sub, cat)">
                                  <div class="flex items-start justify-between mb-2">
                                    <div>
                                      <p class="text-sm font-medium text-gray-800" x-text="sub.name"></p>
                                      <p class="text-[10px] text-gray-500" x-text="sub.description"></p>
                                    </div>
                                    <span :class="{
                                            'bg-green-100 text-green-700': sub.cost === 'cheap',
                                            'bg-yellow-100 text-yellow-700': sub.cost === 'medium',
                                            'bg-orange-100 text-orange-700': sub.cost === 'expensive'
                                          }"
                                          class="text-[8px] px-1.5 py-0.5 rounded font-medium" x-text="sub.cost"></span>
                                  </div>

                                  <!-- Status indicator -->
                                  <div class="flex items-center justify-between mt-3">
                                    <span x-show="sub.status === 'approved'" class="text-xs text-green-600 flex items-center gap-1">
                                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                      <span x-text="(sub.result_count || 0) + ' URLs approved'"></span>
                                    </span>
                                    <span x-show="sub.status === 'has_results'" class="text-xs text-blue-600 flex items-center gap-1">
                                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
                                      <span x-text="(sub.result_count || 0) + ' URLs found'"></span>
                                    </span>
                                    <span x-show="sub.status === 'running'" class="text-xs text-yellow-600">Running...</span>
                                    <span x-show="!sub.status || sub.status === 'pending'" class="text-xs text-gray-400">Not run</span>

                                    <span class="text-[10px] text-brand-600 font-medium">Open â†’</span>
                                  </div>
                                </div>
                              </template>
                            </div>
                          </div>
                        </div>
                      </template>

                      <!-- Discovery Summary -->
                      <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                          <p class="text-xs text-gray-600 font-medium uppercase">Discovery Summary</p>
                          <span class="text-xs text-gray-500" x-text="getTotalApprovedSubmodules() + ' submodules approved'"></span>
                        </div>
                        <div class="flex flex-wrap gap-4 text-sm">
                          <span class="text-gray-700"><span class="font-semibold text-lg" x-text="getTotalDiscoveredUrls()"></span> total URLs</span>
                          <template x-for="(cat, catKey) in discoveryCategories" :key="'sum-' + catKey">
                            <span x-show="getCategoryUrlCount(cat) > 0" class="text-green-600" x-text="cat.label + ': ' + getCategoryUrlCount(cat)"></span>
                          </template>
                        </div>
                      </div>
                    </div>

                    <!-- STEP 2: Validation & Dedup -->
                    <div x-show="i === 2">
                      <div class="bg-orange-50 rounded-lg p-3 border border-orange-200 mb-4">
                        <p class="text-xs text-orange-700 font-medium mb-1">Validation & Deduplication</p>
                        <p class="text-xs text-gray-600">Filter discovered URLs by trust, authority, and compliance. Remove duplicate URLs and mark filtered content.</p>
                      </div>

                      <!-- Input from Step 1 -->
                      <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 mb-4">
                        <div class="flex items-center justify-between mb-2">
                          <p class="text-xs text-gray-600 font-medium">Input from Discovery (Step 1)</p>
                          <span class="text-xs text-green-600" x-text="getTotalDiscoveredUrls() + ' URLs'"></span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                          <template x-for="(cat, catKey) in discoveryCategories" :key="'val-' + catKey">
                            <span x-show="getCategoryUrlCount(cat) > 0" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded" x-text="cat.label + ': ' + getCategoryUrlCount(cat)"></span>
                          </template>
                        </div>
                      </div>

                      <!-- Validation Rules (simplified) -->
                      <p class="text-xs text-gray-500 mb-3 font-medium uppercase">Validation Rules</p>
                      <div class="space-y-2 mb-4">
                        <div class="flex items-center justify-between bg-white rounded-lg border border-gray-200 p-3">
                          <div class="flex items-center gap-3">
                            <input type="checkbox" checked class="rounded border-gray-300 text-brand-600">
                            <div>
                              <p class="text-sm font-medium text-gray-800">Deduplication</p>
                              <p class="text-[10px] text-gray-500">Remove duplicate URLs across sources</p>
                            </div>
                          </div>
                          <span class="text-xs text-gray-500">Always enabled</span>
                        </div>
                        <div class="flex items-center justify-between bg-white rounded-lg border border-gray-200 p-3">
                          <div class="flex items-center gap-3">
                            <input type="checkbox" checked class="rounded border-gray-300 text-brand-600">
                            <div>
                              <p class="text-sm font-medium text-gray-800">Domain Authority Check</p>
                              <p class="text-[10px] text-gray-500">Min DA score: 10</p>
                            </div>
                          </div>
                          <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">cheap</span>
                        </div>
                        <div class="flex items-center justify-between bg-white rounded-lg border border-gray-200 p-3">
                          <div class="flex items-center gap-3">
                            <input type="checkbox" checked class="rounded border-gray-300 text-brand-600">
                            <div>
                              <p class="text-sm font-medium text-gray-800">Blocked Domains</p>
                              <p class="text-[10px] text-gray-500">Filter known spam/low-quality sites</p>
                            </div>
                          </div>
                          <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">cheap</span>
                        </div>
                        <div class="flex items-center justify-between bg-white rounded-lg border border-gray-200 p-3">
                          <div class="flex items-center gap-3">
                            <input type="checkbox" class="rounded border-gray-300 text-brand-600">
                            <div>
                              <p class="text-sm font-medium text-gray-800">Language Filter</p>
                              <p class="text-[10px] text-gray-500">Only English content</p>
                            </div>
                          </div>
                          <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">cheap</span>
                        </div>
                      </div>

                      <!-- Results Summary -->
                      <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-2">Validation Results (mock)</p>
                        <div class="flex flex-wrap gap-4 text-sm">
                          <span class="text-gray-700"><span class="font-semibold">312</span> input URLs</span>
                          <span class="text-green-600"><span class="font-semibold">285</span> passed</span>
                          <span class="text-orange-600"><span class="font-semibold">27</span> filtered</span>
                          <span class="text-gray-400">12 duplicates removed</span>
                        </div>
                      </div>
                    </div>

                    <!-- STEP 3: Content Extraction -->
                    <div x-show="i === 3" x-data="{
                      expandedExtractor: null,
                      extractors: {
                        engines: { enabled: true, label: 'Extraction Engines', icon: 'âš¡', submodules: [
                          { id: 'cheerio', name: 'Cheerio', enabled: true, cost: 'cheap', description: 'Fast HTML parsing', lastResult: '38 pages' },
                          { id: 'playwright', name: 'Playwright', enabled: true, cost: 'medium', description: 'JS-rendered content', lastResult: '2 fallback' },
                          { id: 'jsdom', name: 'JSDOM', enabled: false, cost: 'cheap', description: 'DOM simulation', lastResult: null },
                          { id: 'puppeteer', name: 'Puppeteer', enabled: false, cost: 'medium', description: 'Chrome headless', lastResult: null }
                        ]},
                        content: { enabled: true, label: 'Content Types', icon: 'ðŸ“„', submodules: [
                          { id: 'text-content', name: 'Text Content', enabled: true, cost: 'cheap', description: 'Main body text', lastResult: '40 pages' },
                          { id: 'html-structure', name: 'HTML Structure', enabled: true, cost: 'cheap', description: 'Preserve formatting', lastResult: '40 pages' },
                          { id: 'json-ld', name: 'JSON-LD', enabled: true, cost: 'cheap', description: 'Structured data', lastResult: '12 found' },
                          { id: 'meta-tags', name: 'Meta Tags', enabled: true, cost: 'cheap', description: 'Title, description, OG', lastResult: '40 pages' }
                        ]},
                        media: { enabled: false, label: 'Media', icon: 'ðŸ–¼ï¸', submodules: [
                          { id: 'images', name: 'Images', enabled: false, cost: 'medium', description: 'Download images', lastResult: null },
                          { id: 'videos', name: 'Video Embeds', enabled: false, cost: 'cheap', description: 'Extract video URLs', lastResult: null },
                          { id: 'pdfs', name: 'PDF Content', enabled: false, cost: 'medium', description: 'Parse PDF text', lastResult: null }
                        ]},
                        special: { enabled: false, label: 'Specialized', icon: 'ðŸ”¬', submodules: [
                          { id: 'tables', name: 'Tables', enabled: false, cost: 'cheap', description: 'Extract table data', lastResult: null },
                          { id: 'forms', name: 'Forms', enabled: false, cost: 'cheap', description: 'Form field data', lastResult: null },
                          { id: 'comments', name: 'Comments', enabled: false, cost: 'medium', description: 'User comments', lastResult: null }
                        ]}
                      },
                      toggleExtractor(key) { this.extractors[key].enabled = !this.extractors[key].enabled; },
                      toggleSubmodule(extKey, subId) {
                        const sub = this.extractors[extKey].submodules.find(s => s.id === subId);
                        if (sub) sub.enabled = !sub.enabled;
                      },
                      getEnabledCount(ext) { return ext.submodules.filter(s => s.enabled).length; },
                      getCostClass(cost) {
                        return { cheap: 'bg-green-100 text-green-700', medium: 'bg-yellow-100 text-yellow-700', expensive: 'bg-orange-100 text-orange-700' }[cost];
                      }
                    }">
                      <div class="bg-purple-50 rounded p-3 border border-purple-200 mb-4">
                        <p class="text-xs text-purple-700 font-medium mb-1">Content Extraction</p>
                        <p class="text-xs text-gray-600">Choose extraction engines and what content types to extract. Cheerio runs first; Playwright as fallback for JS-heavy sites.</p>
                      </div>

                      <!-- Extractor Cards Grid -->
                      <p class="text-xs text-gray-500 mb-3">Extraction Configuration (click to configure)</p>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <template x-for="(ext, key) in extractors" :key="key">
                          <div class="rounded-lg border transition-all cursor-pointer"
                               :class="ext.enabled ? 'bg-white border-brand-300 shadow-sm' : 'bg-gray-50 border-gray-200 opacity-60'"
                               @click="expandedExtractor = expandedExtractor === key ? null : key">
                            <div class="p-3">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-lg" x-text="ext.icon"></span>
                                <button @click.stop="toggleExtractor(key)"
                                        class="w-8 h-4 rounded-full relative transition-colors"
                                        :class="ext.enabled ? 'bg-brand-500' : 'bg-gray-300'">
                                  <span class="absolute top-0.5 w-3 h-3 rounded-full bg-white shadow transition-all"
                                        :class="ext.enabled ? 'right-0.5' : 'left-0.5'"></span>
                                </button>
                              </div>
                              <p class="text-sm font-medium text-gray-800" x-text="ext.label"></p>
                              <p class="text-[10px] text-gray-500 mt-1">
                                <span x-text="getEnabledCount(ext)"></span>/<span x-text="ext.submodules.length"></span> active
                              </p>
                            </div>

                            <!-- Expanded Submodule Config -->
                            <div x-show="expandedExtractor === key" x-transition @click.stop class="border-t border-gray-200 p-3 bg-gray-50">
                              <p class="text-[10px] text-gray-500 mb-2 font-medium uppercase">Submodules</p>
                              <div class="space-y-2">
                                <template x-for="sub in ext.submodules" :key="sub.id">
                                  <div class="flex items-center justify-between bg-white rounded p-2 border cursor-pointer hover:bg-gray-50 transition-colors group"
                                       :class="sub.enabled ? 'border-brand-200' : 'border-gray-200 opacity-60'"
                                       @click="$root.openResultsPanel(sub, ext)">
                                    <div class="flex items-center gap-2 min-w-0">
                                      <input type="checkbox" :checked="sub.enabled" @click.stop @change="toggleSubmodule(key, sub.id)"
                                             class="rounded border-gray-300 text-brand-600">
                                      <div class="min-w-0">
                                        <p class="text-xs font-medium text-gray-700 truncate" x-text="sub.name"></p>
                                        <p class="text-[10px] text-gray-400 truncate" x-text="sub.description"></p>
                                      </div>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                                      <span :class="getCostClass(sub.cost)" class="text-[8px] px-1.5 py-0.5 rounded" x-text="sub.cost"></span>
                                      <span x-show="sub.lastResult" class="text-[10px] text-gray-500 group-hover:hidden" x-text="sub.lastResult"></span>
                                      <span class="text-[10px] text-brand-500 hidden group-hover:inline">View â†’</span>
                                    </div>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Global Settings -->
                      <div class="grid grid-cols-3 gap-4 mb-4">
                        <div><label class="block text-xs text-gray-500 mb-1">Timeout (seconds)</label><input type="number" value="30" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">Retry failed</label><select class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"><option>Once with fallback</option><option>No retry</option><option>3 times</option></select></div>
                        <div><label class="block text-xs text-gray-500 mb-1">Concurrent requests</label><input type="number" value="5" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></div>
                      </div>

                      <!-- Results Summary -->
                      <div class="bg-gray-50 rounded p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-2">Extraction Results (mock)</p>
                        <div class="flex flex-wrap gap-4 text-sm">
                          <span class="text-green-600"><span class="font-medium">38</span> extracted</span>
                          <span class="text-yellow-600"><span class="font-medium">2</span> timeouts</span>
                          <span class="text-gray-500">avg <span class="font-medium">1,250</span> words</span>
                        </div>
                      </div>
                    </div>

                    <!-- STEP 5: Filtering & Adaptive Crawl (Card-Based Filters) -->
                    <div x-show="i === 4" x-data="{
                      expandedFilter: null,
                      filters: {
                        dedup: { enabled: true, label: 'Deduplication', icon: 'ðŸ”„', submodules: [
                          { id: 'exact-dedup', name: 'Exact Match', enabled: true, cost: 'cheap', description: 'Remove identical content', lastResult: '2 removed' },
                          { id: 'similarity-dedup', name: 'Similarity Check', enabled: true, cost: 'medium', description: 'Fuzzy dedup (85% threshold)', config: { threshold: 0.85 }, lastResult: '1 removed' },
                          { id: 'url-dedup', name: 'URL Normalization', enabled: true, cost: 'cheap', description: 'Dedupe by canonical URL', lastResult: '0 removed' }
                        ]},
                        quality: { enabled: true, label: 'Quality Filters', icon: 'ðŸ“Š', submodules: [
                          { id: 'min-words', name: 'Min Word Count', enabled: true, cost: 'cheap', description: 'Require 100+ words', config: { min: 100 }, lastResult: '2 filtered' },
                          { id: 'boilerplate', name: 'Boilerplate Removal', enabled: true, cost: 'cheap', description: 'Strip nav/footer text', lastResult: '35 cleaned' },
                          { id: 'readability', name: 'Readability Score', enabled: false, cost: 'cheap', description: 'Min readability level', lastResult: null }
                        ]},
                        relevance: { enabled: true, label: 'Relevance', icon: 'ðŸŽ¯', submodules: [
                          { id: 'topic-match', name: 'Topic Relevance', enabled: true, cost: 'medium', description: 'AI relevance check', lastResult: '2 irrelevant' },
                          { id: 'entity-match', name: 'Entity Match', enabled: true, cost: 'cheap', description: 'Mentions target entity', lastResult: '33 matched' },
                          { id: 'keyword-filter', name: 'Keyword Filter', enabled: false, cost: 'cheap', description: 'Required keywords', lastResult: null }
                        ]},
                        adaptive: { enabled: true, label: 'Adaptive Crawl', icon: 'ðŸ”', submodules: [
                          { id: 'depth-expansion', name: 'Depth Expansion', enabled: true, cost: 'medium', description: 'Crawl deeper if needed', lastResult: '+5 URLs' },
                          { id: 'related-links', name: 'Related Links', enabled: false, cost: 'medium', description: 'Follow related content', lastResult: null }
                        ], isSpecial: true }
                      },
                      toggleFilter(key) { this.filters[key].enabled = !this.filters[key].enabled; },
                      toggleSubmodule(filtKey, subId) {
                        const sub = this.filters[filtKey].submodules.find(s => s.id === subId);
                        if (sub) sub.enabled = !sub.enabled;
                      },
                      getEnabledCount(filt) { return filt.submodules.filter(s => s.enabled).length; },
                      getCostClass(cost) {
                        return { cheap: 'bg-green-100 text-green-700', medium: 'bg-yellow-100 text-yellow-700', expensive: 'bg-orange-100 text-orange-700' }[cost];
                      }
                    }">
                      <div class="bg-orange-50 rounded p-3 border border-orange-200 mb-4">
                        <p class="text-xs text-orange-700 font-medium mb-1">Filter Step</p>
                        <p class="text-xs text-gray-600">Content that fails filtering is marked <code class="bg-orange-100 px-1 rounded">filtered_step5</code>. Adaptive crawl can expand discovery if content is below goal.</p>
                      </div>

                      <!-- Filter Cards Grid -->
                      <p class="text-xs text-gray-500 mb-3">Filter Configuration (click to configure)</p>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <template x-for="(filt, key) in filters" :key="key">
                          <div class="rounded-lg border transition-all cursor-pointer"
                               :class="filt.enabled ? 'bg-white border-brand-300 shadow-sm' : 'bg-gray-50 border-gray-200 opacity-60'"
                               @click="expandedFilter = expandedFilter === key ? null : key">
                            <div class="p-3">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-lg" x-text="filt.icon"></span>
                                <button @click.stop="toggleFilter(key)"
                                        class="w-8 h-4 rounded-full relative transition-colors"
                                        :class="filt.enabled ? 'bg-brand-500' : 'bg-gray-300'">
                                  <span class="absolute top-0.5 w-3 h-3 rounded-full bg-white shadow transition-all"
                                        :class="filt.enabled ? 'right-0.5' : 'left-0.5'"></span>
                                </button>
                              </div>
                              <p class="text-sm font-medium text-gray-800" x-text="filt.label"></p>
                              <p class="text-[10px] text-gray-500 mt-1">
                                <span x-text="getEnabledCount(filt)"></span>/<span x-text="filt.submodules.length"></span> active
                              </p>
                              <p x-show="filt.isSpecial" class="text-[10px] text-blue-600 mt-1">Loop back to Step 2</p>
                            </div>

                            <!-- Expanded Submodule Config -->
                            <div x-show="expandedFilter === key" x-transition @click.stop class="border-t border-gray-200 p-3 bg-gray-50">
                              <p class="text-[10px] text-gray-500 mb-2 font-medium uppercase">Submodules</p>
                              <div class="space-y-2">
                                <template x-for="sub in filt.submodules" :key="sub.id">
                                  <div class="flex items-center justify-between bg-white rounded p-2 border cursor-pointer hover:bg-gray-50 transition-colors group"
                                       :class="sub.enabled ? 'border-brand-200' : 'border-gray-200 opacity-60'"
                                       @click="$root.openResultsPanel(sub, filt)">
                                    <div class="flex items-center gap-2 min-w-0">
                                      <input type="checkbox" :checked="sub.enabled" @click.stop @change="toggleSubmodule(key, sub.id)"
                                             class="rounded border-gray-300 text-brand-600">
                                      <div class="min-w-0">
                                        <p class="text-xs font-medium text-gray-700 truncate" x-text="sub.name"></p>
                                        <p class="text-[10px] text-gray-400 truncate" x-text="sub.description"></p>
                                      </div>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                                      <span :class="getCostClass(sub.cost)" class="text-[8px] px-1.5 py-0.5 rounded" x-text="sub.cost"></span>
                                      <span x-show="sub.lastResult" class="text-[10px] text-gray-500 group-hover:hidden" x-text="sub.lastResult"></span>
                                      <span class="text-[10px] text-brand-500 hidden group-hover:inline">View â†’</span>
                                    </div>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Results Summary -->
                      <div class="bg-gray-50 rounded p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-2">Filter Results (mock)</p>
                        <div class="flex flex-wrap gap-4 text-sm">
                          <span class="text-green-600"><span class="font-medium">33</span> passed</span>
                          <span class="text-orange-600"><span class="font-medium">3</span> duplicates</span>
                          <span class="text-orange-600"><span class="font-medium">2</span> too short</span>
                          <span class="text-orange-600"><span class="font-medium">2</span> irrelevant</span>
                        </div>
                      </div>
                    </div>

                    <!-- STEP 6: Analysis & Generation (Card-Based Generators) -->
                    <div x-show="i === 5" x-data="{
                      expandedGenerator: null,
                      generators: {
                        models: { enabled: true, label: 'AI Models', icon: 'ðŸ¤–', submodules: [
                          { id: 'gpt-4o', name: 'GPT-4o', enabled: true, cost: 'expensive', description: 'Best quality, slower', lastResult: '1 call' },
                          { id: 'gpt-4o-mini', name: 'GPT-4o-mini', enabled: false, cost: 'medium', description: 'Good balance', lastResult: null },
                          { id: 'claude-sonnet', name: 'Claude Sonnet', enabled: false, cost: 'expensive', description: 'Strong reasoning', lastResult: null },
                          { id: 'claude-haiku', name: 'Claude Haiku', enabled: false, cost: 'cheap', description: 'Fast, cost-effective', lastResult: null },
                          { id: 'gemini-pro', name: 'Gemini Pro', enabled: false, cost: 'medium', description: 'Google AI', lastResult: null }
                        ]},
                        types: { enabled: true, label: 'Generation Types', icon: 'ðŸ“', submodules: [
                          { id: 'profile', name: 'Company Profile', enabled: true, cost: 'expensive', description: 'Full structured profile', lastResult: '1 generated' },
                          { id: 'summary', name: 'Summary', enabled: false, cost: 'medium', description: 'Concise overview', lastResult: null },
                          { id: 'article', name: 'Article Rewrite', enabled: false, cost: 'medium', description: 'News article format', lastResult: null },
                          { id: 'faq', name: 'FAQ Generation', enabled: false, cost: 'medium', description: 'Q&A format', lastResult: null },
                          { id: 'analysis', name: 'Analysis Report', enabled: false, cost: 'expensive', description: 'In-depth analysis', lastResult: null }
                        ]},
                        tagging: { enabled: true, label: 'Auto-tagging', icon: 'ðŸ·ï¸', submodules: [
                          { id: 'entity-extract', name: 'Entity Extraction', enabled: true, cost: 'medium', description: 'LLM-based NER', lastResult: '47 entities' },
                          { id: 'topic-classify', name: 'Topic Classification', enabled: true, cost: 'medium', description: 'Categorize content', lastResult: '12 topics' },
                          { id: 'rule-based', name: 'Rule-based Tags', enabled: false, cost: 'cheap', description: 'Keyword matching', lastResult: null },
                          { id: 'confidence', name: 'Confidence Scores', enabled: true, cost: 'cheap', description: 'Add confidence values', lastResult: '0.92 avg' }
                        ]},
                        output: { enabled: true, label: 'Output Formats', icon: 'ðŸ“„', submodules: [
                          { id: 'markdown', name: 'Markdown', enabled: true, cost: 'cheap', description: 'Standard markdown', lastResult: 'primary' },
                          { id: 'html', name: 'HTML', enabled: false, cost: 'cheap', description: 'Formatted HTML', lastResult: null },
                          { id: 'json', name: 'JSON', enabled: true, cost: 'cheap', description: 'Structured data', lastResult: 'generated' }
                        ]}
                      },
                      toggleGenerator(key) { this.generators[key].enabled = !this.generators[key].enabled; },
                      toggleSubmodule(genKey, subId) {
                        const sub = this.generators[genKey].submodules.find(s => s.id === subId);
                        if (sub) sub.enabled = !sub.enabled;
                      },
                      getEnabledCount(gen) { return gen.submodules.filter(s => s.enabled).length; },
                      getCostClass(cost) {
                        return { cheap: 'bg-green-100 text-green-700', medium: 'bg-yellow-100 text-yellow-700', expensive: 'bg-orange-100 text-orange-700' }[cost];
                      }
                    }">
                      <div class="bg-indigo-50 rounded p-3 border border-indigo-200 mb-4">
                        <p class="text-xs text-indigo-700 font-medium mb-1">Content Generation</p>
                        <p class="text-xs text-gray-600">Configure AI models, generation types, and auto-tagging. Multiple models can be used for different tasks or as fallbacks.</p>
                      </div>

                      <!-- Generator Cards Grid -->
                      <p class="text-xs text-gray-500 mb-3">Generation Configuration (click to configure)</p>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <template x-for="(gen, key) in generators" :key="key">
                          <div class="rounded-lg border transition-all cursor-pointer"
                               :class="gen.enabled ? 'bg-white border-brand-300 shadow-sm' : 'bg-gray-50 border-gray-200 opacity-60'"
                               @click="expandedGenerator = expandedGenerator === key ? null : key">
                            <div class="p-3">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-lg" x-text="gen.icon"></span>
                                <button @click.stop="toggleGenerator(key)"
                                        class="w-8 h-4 rounded-full relative transition-colors"
                                        :class="gen.enabled ? 'bg-brand-500' : 'bg-gray-300'">
                                  <span class="absolute top-0.5 w-3 h-3 rounded-full bg-white shadow transition-all"
                                        :class="gen.enabled ? 'right-0.5' : 'left-0.5'"></span>
                                </button>
                              </div>
                              <p class="text-sm font-medium text-gray-800" x-text="gen.label"></p>
                              <p class="text-[10px] text-gray-500 mt-1">
                                <span x-text="getEnabledCount(gen)"></span>/<span x-text="gen.submodules.length"></span> active
                              </p>
                            </div>

                            <!-- Expanded Submodule Config -->
                            <div x-show="expandedGenerator === key" x-transition @click.stop class="border-t border-gray-200 p-3 bg-gray-50">
                              <p class="text-[10px] text-gray-500 mb-2 font-medium uppercase">Submodules</p>
                              <div class="space-y-2">
                                <template x-for="sub in gen.submodules" :key="sub.id">
                                  <div class="flex items-center justify-between bg-white rounded p-2 border cursor-pointer hover:bg-gray-50 transition-colors group"
                                       :class="sub.enabled ? 'border-brand-200' : 'border-gray-200 opacity-60'"
                                       @click="$root.openResultsPanel(sub, gen)">
                                    <div class="flex items-center gap-2 min-w-0">
                                      <input type="checkbox" :checked="sub.enabled" @click.stop @change="toggleSubmodule(key, sub.id)"
                                             class="rounded border-gray-300 text-brand-600">
                                      <div class="min-w-0">
                                        <p class="text-xs font-medium text-gray-700 truncate" x-text="sub.name"></p>
                                        <p class="text-[10px] text-gray-400 truncate" x-text="sub.description"></p>
                                      </div>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                                      <span :class="getCostClass(sub.cost)" class="text-[8px] px-1.5 py-0.5 rounded" x-text="sub.cost"></span>
                                      <span x-show="sub.lastResult" class="text-[10px] text-gray-500 group-hover:hidden" x-text="sub.lastResult"></span>
                                      <span class="text-[10px] text-brand-500 hidden group-hover:inline">View â†’</span>
                                    </div>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Global Settings -->
                      <div class="grid grid-cols-3 gap-4 mb-4">
                        <div><label class="block text-xs text-gray-500 mb-1">Temperature</label><input type="number" value="0.3" step="0.1" min="0" max="1" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">Max Tokens</label><input type="number" value="4000" step="500" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">Fallback Model</label><select class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"><option>GPT-4o-mini</option><option>Claude Haiku</option><option>None</option></select></div>
                      </div>

                      <!-- Results Summary -->
                      <div class="bg-gray-50 rounded p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-2">Generation Results (mock)</p>
                        <div class="flex flex-wrap gap-4 text-sm">
                          <span class="text-green-600"><span class="font-medium">1</span> profile generated</span>
                          <span class="text-blue-600"><span class="font-medium">28</span> sources used</span>
                          <span class="text-purple-600"><span class="font-medium">127</span> tags applied</span>
                          <span class="text-gray-500">avg confidence: <span class="font-medium">0.92</span></span>
                        </div>
                      </div>
                    </div>

                    <!-- STEP 7: Validation & QA (Card-Based QA Checks) -->
                    <div x-show="i === 6" x-data="{
                      expandedQA: null,
                      qaChecks: {
                        accuracy: { enabled: true, label: 'Accuracy', icon: 'ðŸ”', submodules: [
                          { id: 'fact-verify', name: 'Fact Verification', enabled: true, cost: 'expensive', description: 'Cross-check with sources', lastResult: 'pass' },
                          { id: 'hallucination', name: 'Hallucination Detection', enabled: true, cost: 'expensive', description: 'Detect unsupported claims', lastResult: 'pass' },
                          { id: 'citation-check', name: 'Citation Check', enabled: true, cost: 'cheap', description: 'Verify all citations exist', lastResult: 'pass' }
                        ]},
                        structure: { enabled: true, label: 'Structure', icon: 'ðŸ“', submodules: [
                          { id: 'format-valid', name: 'Format Validation', enabled: true, cost: 'cheap', description: 'Check output format', lastResult: 'pass' },
                          { id: 'completeness', name: 'Completeness Check', enabled: true, cost: 'cheap', description: 'All required fields', lastResult: 'pass' },
                          { id: 'schema-valid', name: 'Schema Validation', enabled: false, cost: 'cheap', description: 'Validate JSON schema', lastResult: null }
                        ]},
                        quality: { enabled: true, label: 'Quality', icon: 'â­', submodules: [
                          { id: 'readability', name: 'Readability Score', enabled: false, cost: 'cheap', description: 'Flesch-Kincaid score', lastResult: null },
                          { id: 'grammar', name: 'Grammar Check', enabled: false, cost: 'cheap', description: 'Spelling & grammar', lastResult: null },
                          { id: 'consistency', name: 'Consistency', enabled: true, cost: 'medium', description: 'Style consistency', lastResult: 'pass' }
                        ]},
                        seo: { enabled: false, label: 'SEO', icon: 'ðŸ”Ž', submodules: [
                          { id: 'meta-tags', name: 'Meta Tags', enabled: false, cost: 'cheap', description: 'Title, description length', lastResult: null },
                          { id: 'keyword-density', name: 'Keyword Density', enabled: false, cost: 'cheap', description: 'Check keyword usage', lastResult: null },
                          { id: 'heading-structure', name: 'Heading Structure', enabled: false, cost: 'cheap', description: 'H1-H6 hierarchy', lastResult: null }
                        ]}
                      },
                      toggleQA(key) { this.qaChecks[key].enabled = !this.qaChecks[key].enabled; },
                      toggleSubmodule(qaKey, subId) {
                        const sub = this.qaChecks[qaKey].submodules.find(s => s.id === subId);
                        if (sub) sub.enabled = !sub.enabled;
                      },
                      getEnabledCount(qa) { return qa.submodules.filter(s => s.enabled).length; },
                      getCostClass(cost) {
                        return { cheap: 'bg-green-100 text-green-700', medium: 'bg-yellow-100 text-yellow-700', expensive: 'bg-orange-100 text-orange-700' }[cost];
                      },
                      getResultClass(result) {
                        if (result === 'pass') return 'text-green-600';
                        if (result === 'fail') return 'text-red-600';
                        return 'text-gray-500';
                      }
                    }">
                      <div class="bg-teal-50 rounded p-3 border border-teal-200 mb-4">
                        <p class="text-xs text-teal-700 font-medium mb-1">Quality Assurance</p>
                        <p class="text-xs text-gray-600">Configure QA checks to validate generated content. Failed checks can trigger regeneration or flag for manual review.</p>
                      </div>

                      <!-- QA Cards Grid -->
                      <p class="text-xs text-gray-500 mb-3">QA Configuration (click to configure)</p>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <template x-for="(qa, key) in qaChecks" :key="key">
                          <div class="rounded-lg border transition-all cursor-pointer"
                               :class="qa.enabled ? 'bg-white border-brand-300 shadow-sm' : 'bg-gray-50 border-gray-200 opacity-60'"
                               @click="expandedQA = expandedQA === key ? null : key">
                            <div class="p-3">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-lg" x-text="qa.icon"></span>
                                <button @click.stop="toggleQA(key)"
                                        class="w-8 h-4 rounded-full relative transition-colors"
                                        :class="qa.enabled ? 'bg-brand-500' : 'bg-gray-300'">
                                  <span class="absolute top-0.5 w-3 h-3 rounded-full bg-white shadow transition-all"
                                        :class="qa.enabled ? 'right-0.5' : 'left-0.5'"></span>
                                </button>
                              </div>
                              <p class="text-sm font-medium text-gray-800" x-text="qa.label"></p>
                              <p class="text-[10px] text-gray-500 mt-1">
                                <span x-text="getEnabledCount(qa)"></span>/<span x-text="qa.submodules.length"></span> checks
                              </p>
                            </div>

                            <!-- Expanded Submodule Config -->
                            <div x-show="expandedQA === key" x-transition @click.stop class="border-t border-gray-200 p-3 bg-gray-50">
                              <p class="text-[10px] text-gray-500 mb-2 font-medium uppercase">Checks</p>
                              <div class="space-y-2">
                                <template x-for="sub in qa.submodules" :key="sub.id">
                                  <div class="flex items-center justify-between bg-white rounded p-2 border cursor-pointer hover:bg-gray-50 transition-colors group"
                                       :class="sub.enabled ? 'border-brand-200' : 'border-gray-200 opacity-60'"
                                       @click="$root.openResultsPanel(sub, qa)">
                                    <div class="flex items-center gap-2 min-w-0">
                                      <input type="checkbox" :checked="sub.enabled" @click.stop @change="toggleSubmodule(key, sub.id)"
                                             class="rounded border-gray-300 text-brand-600">
                                      <div class="min-w-0">
                                        <p class="text-xs font-medium text-gray-700 truncate" x-text="sub.name"></p>
                                        <p class="text-[10px] text-gray-400 truncate" x-text="sub.description"></p>
                                      </div>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                                      <span :class="getCostClass(sub.cost)" class="text-[8px] px-1.5 py-0.5 rounded" x-text="sub.cost"></span>
                                      <span x-show="sub.lastResult" :class="getResultClass(sub.lastResult)" class="text-[10px] font-medium group-hover:hidden" x-text="sub.lastResult"></span>
                                      <span class="text-[10px] text-brand-500 hidden group-hover:inline">View â†’</span>
                                    </div>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Global Settings -->
                      <div class="grid grid-cols-3 gap-4 mb-4">
                        <div><label class="block text-xs text-gray-500 mb-1">Min Quality Score</label><input type="number" value="0.85" step="0.05" min="0" max="1" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">Auto-approve above</label><input type="number" value="0.95" step="0.05" min="0" max="1" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">On Failure</label><select class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"><option>Flag for review</option><option>Regenerate</option><option>Skip</option></select></div>
                      </div>

                      <!-- Results Summary -->
                      <div class="bg-gray-50 rounded p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-2">QA Results (mock)</p>
                        <div class="flex flex-wrap gap-4 text-sm">
                          <span class="text-green-600">Score: <span class="font-medium">0.95</span></span>
                          <span class="text-green-600">Facts: <span class="font-medium">pass</span></span>
                          <span class="text-green-600">Structure: <span class="font-medium">pass</span></span>
                          <span class="text-yellow-600">SEO: <span class="font-medium">skipped</span></span>
                        </div>
                      </div>
                    </div>

                    <!-- STEP 8: Routing & Flow (Card-Based Routing Rules) -->
                    <div x-show="i === 7" x-data="{
                      expandedRoute: null,
                      routes: {
                        quality: { enabled: true, label: 'Quality-Based', icon: 'ðŸ“Š', submodules: [
                          { id: 'high-quality', name: 'High Quality (â‰¥0.9)', enabled: true, cost: 'cheap', description: 'Direct to bundling', action: 'Step 9', lastResult: '1 item' },
                          { id: 'medium-quality', name: 'Medium (0.7-0.9)', enabled: true, cost: 'cheap', description: 'Manual review queue', action: 'Review', lastResult: '0 items' },
                          { id: 'low-quality', name: 'Low (<0.7)', enabled: true, cost: 'cheap', description: 'Regenerate content', action: 'Step 6', lastResult: '0 items' }
                        ]},
                        content: { enabled: true, label: 'Content-Based', icon: 'ðŸ“', submodules: [
                          { id: 'content-complete', name: 'Complete Content', enabled: true, cost: 'cheap', description: 'All required fields present', action: 'Continue', lastResult: 'pass' },
                          { id: 'content-partial', name: 'Partial Content', enabled: true, cost: 'cheap', description: 'Missing optional fields', action: 'Flag', lastResult: null },
                          { id: 'content-insufficient', name: 'Insufficient', enabled: true, cost: 'cheap', description: 'Too few sources used', action: 'Step 2', lastResult: null }
                        ]},
                        retry: { enabled: true, label: 'Retry Logic', icon: 'ðŸ”„', submodules: [
                          { id: 'retry-once', name: 'Retry Once', enabled: true, cost: 'cheap', description: 'Retry failed stages once', lastResult: 'active' },
                          { id: 'retry-multi', name: 'Retry Multiple', enabled: false, cost: 'cheap', description: 'Up to 3 retries', lastResult: null },
                          { id: 'exponential-backoff', name: 'Exponential Backoff', enabled: false, cost: 'cheap', description: 'Delay between retries', lastResult: null }
                        ]},
                        loops: { enabled: true, label: 'Loop Triggers', icon: 'ðŸ”', submodules: [
                          { id: 'content-goal', name: 'Content Goal', enabled: true, cost: 'medium', description: 'Re-discover if below target', action: 'Step 2', lastResult: 'not triggered' },
                          { id: 'quality-loop', name: 'Quality Loop', enabled: false, cost: 'medium', description: 'Re-generate if low quality', action: 'Step 6', lastResult: null }
                        ], isSpecial: true }
                      },
                      toggleRoute(key) { this.routes[key].enabled = !this.routes[key].enabled; },
                      toggleSubmodule(routeKey, subId) {
                        const sub = this.routes[routeKey].submodules.find(s => s.id === subId);
                        if (sub) sub.enabled = !sub.enabled;
                      },
                      getEnabledCount(route) { return route.submodules.filter(s => s.enabled).length; },
                      getCostClass(cost) {
                        return { cheap: 'bg-green-100 text-green-700', medium: 'bg-yellow-100 text-yellow-700', expensive: 'bg-orange-100 text-orange-700' }[cost];
                      }
                    }">
                      <div class="bg-cyan-50 rounded p-3 border border-cyan-200 mb-4">
                        <p class="text-xs text-cyan-700 font-medium mb-1">Routing & Flow Control</p>
                        <p class="text-xs text-gray-600">Define routing rules that determine where content goes based on quality, completeness, and other criteria. Enable loops for adaptive processing.</p>
                      </div>

                      <!-- Route Cards Grid -->
                      <p class="text-xs text-gray-500 mb-3">Routing Configuration (click to configure)</p>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <template x-for="(route, key) in routes" :key="key">
                          <div class="rounded-lg border transition-all cursor-pointer"
                               :class="route.enabled ? 'bg-white border-brand-300 shadow-sm' : 'bg-gray-50 border-gray-200 opacity-60'"
                               @click="expandedRoute = expandedRoute === key ? null : key">
                            <div class="p-3">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-lg" x-text="route.icon"></span>
                                <button @click.stop="toggleRoute(key)"
                                        class="w-8 h-4 rounded-full relative transition-colors"
                                        :class="route.enabled ? 'bg-brand-500' : 'bg-gray-300'">
                                  <span class="absolute top-0.5 w-3 h-3 rounded-full bg-white shadow transition-all"
                                        :class="route.enabled ? 'right-0.5' : 'left-0.5'"></span>
                                </button>
                              </div>
                              <p class="text-sm font-medium text-gray-800" x-text="route.label"></p>
                              <p class="text-[10px] text-gray-500 mt-1">
                                <span x-text="getEnabledCount(route)"></span>/<span x-text="route.submodules.length"></span> rules
                              </p>
                              <p x-show="route.isSpecial" class="text-[10px] text-blue-600 mt-1">Can loop back</p>
                            </div>

                            <!-- Expanded Submodule Config -->
                            <div x-show="expandedRoute === key" x-transition @click.stop class="border-t border-gray-200 p-3 bg-gray-50">
                              <p class="text-[10px] text-gray-500 mb-2 font-medium uppercase">Rules</p>
                              <div class="space-y-2">
                                <template x-for="sub in route.submodules" :key="sub.id">
                                  <div class="flex items-center justify-between bg-white rounded p-2 border cursor-pointer hover:bg-gray-50 transition-colors group"
                                       :class="sub.enabled ? 'border-brand-200' : 'border-gray-200 opacity-60'"
                                       @click="$root.openResultsPanel(sub, route)">
                                    <div class="flex items-center gap-2 min-w-0">
                                      <input type="checkbox" :checked="sub.enabled" @click.stop @change="toggleSubmodule(key, sub.id)"
                                             class="rounded border-gray-300 text-brand-600">
                                      <div class="min-w-0">
                                        <p class="text-xs font-medium text-gray-700 truncate" x-text="sub.name"></p>
                                        <p class="text-[10px] text-gray-400 truncate" x-text="sub.description"></p>
                                      </div>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                                      <span x-show="sub.action" class="text-[8px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded group-hover:hidden" x-text="'â†’ ' + sub.action"></span>
                                      <span x-show="sub.lastResult && !sub.action" class="text-[10px] text-gray-500 group-hover:hidden" x-text="sub.lastResult"></span>
                                      <span class="text-[10px] text-brand-500 hidden group-hover:inline">View â†’</span>
                                    </div>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Global Settings -->
                      <div class="grid grid-cols-3 gap-4 mb-4">
                        <div><label class="block text-xs text-gray-500 mb-1">Max Loop Iterations</label><input type="number" value="3" min="1" max="10" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">Timeout per Loop</label><select class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"><option>5 minutes</option><option>10 minutes</option><option>30 minutes</option></select></div>
                        <div><label class="block text-xs text-gray-500 mb-1">On Max Loops</label><select class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"><option>Flag for review</option><option>Proceed anyway</option><option>Fail</option></select></div>
                      </div>

                      <!-- Results Summary -->
                      <div class="bg-gray-50 rounded p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-2">Routing Decision (mock)</p>
                        <div class="flex flex-wrap gap-4 text-sm">
                          <span class="text-green-600"><span class="font-medium">1</span> routed to bundling</span>
                          <span class="text-gray-500"><span class="font-medium">0</span> to review</span>
                          <span class="text-gray-500"><span class="font-medium">0</span> loops triggered</span>
                        </div>
                      </div>
                    </div>

                    <!-- STEP 9: Output Bundling (Card-Based Output Formats) -->
                    <div x-show="i === 8" x-data="{
                      expandedBundle: null,
                      bundles: {
                        formats: { enabled: true, label: 'Output Formats', icon: 'ðŸ“¦', submodules: [
                          { id: 'markdown', name: 'Markdown', enabled: true, cost: 'cheap', description: 'Standard .md file', lastResult: '12 KB' },
                          { id: 'json', name: 'JSON', enabled: true, cost: 'cheap', description: 'Structured data', lastResult: '18 KB' },
                          { id: 'html', name: 'HTML', enabled: true, cost: 'cheap', description: 'Formatted HTML', lastResult: '15 KB' },
                          { id: 'xml-rss', name: 'XML/RSS', enabled: false, cost: 'cheap', description: 'Feed format', lastResult: null }
                        ]},
                        metadata: { enabled: true, label: 'Metadata', icon: 'ðŸ·ï¸', submodules: [
                          { id: 'citations', name: 'Source Citations', enabled: true, cost: 'cheap', description: 'Include source URLs', lastResult: '28 sources' },
                          { id: 'tags-confidence', name: 'Tags & Confidence', enabled: true, cost: 'cheap', description: 'Tag data with scores', lastResult: '127 tags' },
                          { id: 'seo-meta', name: 'SEO Metadata', enabled: true, cost: 'cheap', description: 'Title, description, OG', lastResult: 'included' },
                          { id: 'schema-org', name: 'Schema.org', enabled: false, cost: 'cheap', description: 'JSON-LD structured data', lastResult: null }
                        ]},
                        audit: { enabled: false, label: 'Audit Trail', icon: 'ðŸ“‹', submodules: [
                          { id: 'processing-log', name: 'Processing Log', enabled: false, cost: 'cheap', description: 'Full processing history', lastResult: null },
                          { id: 'source-snapshots', name: 'Source Snapshots', enabled: false, cost: 'medium', description: 'Cached source content', lastResult: null },
                          { id: 'version-history', name: 'Version History', enabled: false, cost: 'cheap', description: 'Previous versions', lastResult: null }
                        ]},
                        assets: { enabled: false, label: 'Assets', icon: 'ðŸ–¼ï¸', submodules: [
                          { id: 'images', name: 'Images', enabled: false, cost: 'medium', description: 'Download & bundle images', lastResult: null },
                          { id: 'thumbnails', name: 'Thumbnails', enabled: false, cost: 'cheap', description: 'Generate thumbnails', lastResult: null },
                          { id: 'attachments', name: 'Attachments', enabled: false, cost: 'cheap', description: 'PDFs, docs, etc.', lastResult: null }
                        ]}
                      },
                      toggleBundle(key) { this.bundles[key].enabled = !this.bundles[key].enabled; },
                      toggleSubmodule(bundleKey, subId) {
                        const sub = this.bundles[bundleKey].submodules.find(s => s.id === subId);
                        if (sub) sub.enabled = !sub.enabled;
                      },
                      getEnabledCount(bundle) { return bundle.submodules.filter(s => s.enabled).length; },
                      getCostClass(cost) {
                        return { cheap: 'bg-green-100 text-green-700', medium: 'bg-yellow-100 text-yellow-700', expensive: 'bg-orange-100 text-orange-700' }[cost];
                      }
                    }">
                      <div class="bg-violet-50 rounded p-3 border border-violet-200 mb-4">
                        <p class="text-xs text-violet-700 font-medium mb-1">Output Bundling</p>
                        <p class="text-xs text-gray-600">Configure output formats and what metadata to include in the final bundle. Multiple formats can be generated simultaneously.</p>
                      </div>

                      <!-- Bundle Cards Grid -->
                      <p class="text-xs text-gray-500 mb-3">Bundle Configuration (click to configure)</p>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <template x-for="(bundle, key) in bundles" :key="key">
                          <div class="rounded-lg border transition-all cursor-pointer"
                               :class="bundle.enabled ? 'bg-white border-brand-300 shadow-sm' : 'bg-gray-50 border-gray-200 opacity-60'"
                               @click="expandedBundle = expandedBundle === key ? null : key">
                            <div class="p-3">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-lg" x-text="bundle.icon"></span>
                                <button @click.stop="toggleBundle(key)"
                                        class="w-8 h-4 rounded-full relative transition-colors"
                                        :class="bundle.enabled ? 'bg-brand-500' : 'bg-gray-300'">
                                  <span class="absolute top-0.5 w-3 h-3 rounded-full bg-white shadow transition-all"
                                        :class="bundle.enabled ? 'right-0.5' : 'left-0.5'"></span>
                                </button>
                              </div>
                              <p class="text-sm font-medium text-gray-800" x-text="bundle.label"></p>
                              <p class="text-[10px] text-gray-500 mt-1">
                                <span x-text="getEnabledCount(bundle)"></span>/<span x-text="bundle.submodules.length"></span> active
                              </p>
                            </div>

                            <!-- Expanded Submodule Config -->
                            <div x-show="expandedBundle === key" x-transition @click.stop class="border-t border-gray-200 p-3 bg-gray-50">
                              <p class="text-[10px] text-gray-500 mb-2 font-medium uppercase">Options</p>
                              <div class="space-y-2">
                                <template x-for="sub in bundle.submodules" :key="sub.id">
                                  <div class="flex items-center justify-between bg-white rounded p-2 border cursor-pointer hover:bg-gray-50 transition-colors group"
                                       :class="sub.enabled ? 'border-brand-200' : 'border-gray-200 opacity-60'"
                                       @click="$root.openResultsPanel(sub, bundle)">
                                    <div class="flex items-center gap-2 min-w-0">
                                      <input type="checkbox" :checked="sub.enabled" @click.stop @change="toggleSubmodule(key, sub.id)"
                                             class="rounded border-gray-300 text-brand-600">
                                      <div class="min-w-0">
                                        <p class="text-xs font-medium text-gray-700 truncate" x-text="sub.name"></p>
                                        <p class="text-[10px] text-gray-400 truncate" x-text="sub.description"></p>
                                      </div>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                                      <span :class="getCostClass(sub.cost)" class="text-[8px] px-1.5 py-0.5 rounded" x-text="sub.cost"></span>
                                      <span x-show="sub.lastResult" class="text-[10px] text-gray-500 group-hover:hidden" x-text="sub.lastResult"></span>
                                      <span class="text-[10px] text-brand-500 hidden group-hover:inline">View â†’</span>
                                    </div>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Global Settings -->
                      <div class="grid grid-cols-3 gap-4 mb-4">
                        <div><label class="block text-xs text-gray-500 mb-1">Compression</label><select class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"><option>None</option><option>Gzip</option><option>ZIP archive</option></select></div>
                        <div><label class="block text-xs text-gray-500 mb-1">File Naming</label><select class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"><option>Slug-based</option><option>ID-based</option><option>Date-prefixed</option></select></div>
                        <div><label class="block text-xs text-gray-500 mb-1">Max Bundle Size</label><input type="text" value="10 MB" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></div>
                      </div>

                      <!-- Results Summary -->
                      <div class="bg-gray-50 rounded p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-2">Bundle Preview (mock)</p>
                        <div class="flex flex-wrap gap-4 text-sm">
                          <span class="text-green-600"><span class="font-medium">3</span> formats</span>
                          <span class="text-blue-600">Total: <span class="font-medium">48 KB</span></span>
                          <span class="text-purple-600"><span class="font-medium">28</span> citations</span>
                          <span class="text-gray-500"><span class="font-medium">127</span> tags</span>
                        </div>
                      </div>
                    </div>

                    <!-- STEP 10: Distribution (Card-Based Destinations) -->
                    <div x-show="i === 9" x-data="{
                      expandedDest: null,
                      destinations: {
                        cms: { enabled: true, label: 'CMS', icon: 'ðŸŒ', submodules: [
                          { id: 'plasmic', name: 'Plasmic', enabled: true, cost: 'cheap', description: 'Push to Plasmic CMS', lastResult: 'published' },
                          { id: 'wordpress', name: 'WordPress', enabled: false, cost: 'cheap', description: 'WP REST API', lastResult: null },
                          { id: 'sanity', name: 'Sanity', enabled: false, cost: 'cheap', description: 'Sanity.io', lastResult: null }
                        ]},
                        api: { enabled: true, label: 'API/Database', icon: 'ðŸ”Œ', submodules: [
                          { id: 'internal-api', name: 'Internal API', enabled: true, cost: 'cheap', description: 'Push to data API', lastResult: 'updated' },
                          { id: 'supabase', name: 'Supabase', enabled: true, cost: 'cheap', description: 'Store in Supabase', lastResult: 'saved' },
                          { id: 'webhook', name: 'Webhook', enabled: false, cost: 'cheap', description: 'POST to webhook URL', lastResult: null }
                        ]},
                        storage: { enabled: false, label: 'Storage', icon: 'ðŸ’¾', submodules: [
                          { id: 's3', name: 'AWS S3', enabled: false, cost: 'cheap', description: 'Upload to S3 bucket', lastResult: null },
                          { id: 'gcs', name: 'Google Cloud', enabled: false, cost: 'cheap', description: 'GCS bucket', lastResult: null },
                          { id: 'local', name: 'Local Files', enabled: false, cost: 'cheap', description: 'Save to filesystem', lastResult: null }
                        ]},
                        notify: { enabled: false, label: 'Notifications', icon: 'ðŸ“§', submodules: [
                          { id: 'email', name: 'Email', enabled: false, cost: 'cheap', description: 'Send email notification', lastResult: null },
                          { id: 'slack', name: 'Slack', enabled: false, cost: 'cheap', description: 'Post to Slack channel', lastResult: null },
                          { id: 'discord', name: 'Discord', enabled: false, cost: 'cheap', description: 'Discord webhook', lastResult: null }
                        ]}
                      },
                      toggleDest(key) { this.destinations[key].enabled = !this.destinations[key].enabled; },
                      toggleSubmodule(destKey, subId) {
                        const sub = this.destinations[destKey].submodules.find(s => s.id === subId);
                        if (sub) sub.enabled = !sub.enabled;
                      },
                      getEnabledCount(dest) { return dest.submodules.filter(s => s.enabled).length; },
                      getCostClass(cost) {
                        return { cheap: 'bg-green-100 text-green-700', medium: 'bg-yellow-100 text-yellow-700', expensive: 'bg-orange-100 text-orange-700' }[cost];
                      },
                      getResultClass(result) {
                        if (result === 'published' || result === 'updated' || result === 'saved') return 'text-green-600';
                        if (result === 'failed') return 'text-red-600';
                        return 'text-gray-500';
                      }
                    }">
                      <div class="bg-emerald-50 rounded p-3 border border-emerald-200 mb-4">
                        <p class="text-xs text-emerald-700 font-medium mb-1">Distribution</p>
                        <p class="text-xs text-gray-600">Configure where content is published. Multiple destinations can be active simultaneously for multi-channel distribution.</p>
                      </div>

                      <!-- Destination Cards Grid -->
                      <p class="text-xs text-gray-500 mb-3">Destination Configuration (click to configure)</p>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <template x-for="(dest, key) in destinations" :key="key">
                          <div class="rounded-lg border transition-all cursor-pointer"
                               :class="dest.enabled ? 'bg-white border-brand-300 shadow-sm' : 'bg-gray-50 border-gray-200 opacity-60'"
                               @click="expandedDest = expandedDest === key ? null : key">
                            <div class="p-3">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-lg" x-text="dest.icon"></span>
                                <button @click.stop="toggleDest(key)"
                                        class="w-8 h-4 rounded-full relative transition-colors"
                                        :class="dest.enabled ? 'bg-brand-500' : 'bg-gray-300'">
                                  <span class="absolute top-0.5 w-3 h-3 rounded-full bg-white shadow transition-all"
                                        :class="dest.enabled ? 'right-0.5' : 'left-0.5'"></span>
                                </button>
                              </div>
                              <p class="text-sm font-medium text-gray-800" x-text="dest.label"></p>
                              <p class="text-[10px] text-gray-500 mt-1">
                                <span x-text="getEnabledCount(dest)"></span>/<span x-text="dest.submodules.length"></span> active
                              </p>
                            </div>

                            <!-- Expanded Submodule Config -->
                            <div x-show="expandedDest === key" x-transition @click.stop class="border-t border-gray-200 p-3 bg-gray-50">
                              <p class="text-[10px] text-gray-500 mb-2 font-medium uppercase">Destinations</p>
                              <div class="space-y-2">
                                <template x-for="sub in dest.submodules" :key="sub.id">
                                  <div class="flex items-center justify-between bg-white rounded p-2 border cursor-pointer hover:bg-gray-50 transition-colors group"
                                       :class="sub.enabled ? 'border-brand-200' : 'border-gray-200 opacity-60'"
                                       @click="$root.openResultsPanel(sub, dest)">
                                    <div class="flex items-center gap-2 min-w-0">
                                      <input type="checkbox" :checked="sub.enabled" @click.stop @change="toggleSubmodule(key, sub.id)"
                                             class="rounded border-gray-300 text-brand-600">
                                      <div class="min-w-0">
                                        <p class="text-xs font-medium text-gray-700 truncate" x-text="sub.name"></p>
                                        <p class="text-[10px] text-gray-400 truncate" x-text="sub.description"></p>
                                      </div>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                                      <span :class="getCostClass(sub.cost)" class="text-[8px] px-1.5 py-0.5 rounded" x-text="sub.cost"></span>
                                      <span x-show="sub.lastResult" :class="getResultClass(sub.lastResult)" class="text-[10px] font-medium group-hover:hidden" x-text="sub.lastResult"></span>
                                      <span class="text-[10px] text-brand-500 hidden group-hover:inline">View â†’</span>
                                    </div>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Global Settings -->
                      <div class="grid grid-cols-3 gap-4 mb-4">
                        <div><label class="block text-xs text-gray-500 mb-1">Publishing</label><select class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"><option>Immediate</option><option>Scheduled</option><option>Draft (manual)</option></select></div>
                        <div><label class="block text-xs text-gray-500 mb-1">Versioning</label><select class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"><option>Create new version</option><option>Overwrite existing</option><option>Archive old</option></select></div>
                        <div><label class="block text-xs text-gray-500 mb-1">On Failure</label><select class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"><option>Retry once</option><option>Skip destination</option><option>Abort all</option></select></div>
                      </div>

                      <!-- Results Summary -->
                      <div class="bg-gray-50 rounded p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-2">Distribution Status (mock)</p>
                        <div class="flex flex-wrap gap-4 text-sm">
                          <span class="text-green-600"><span class="font-medium">3</span> destinations</span>
                          <span class="text-green-600">CMS: <span class="font-medium">published</span></span>
                          <span class="text-green-600">API: <span class="font-medium">updated</span></span>
                          <span class="text-green-600">DB: <span class="font-medium">saved</span></span>
                        </div>
                      </div>
                    </div>

                    <!-- STEP 11: Review & Triggers (Card-Based Actions) -->
                    <div x-show="i === 10" x-data="{
                      expandedAction: null,
                      reviewDecision: null,
                      actions: {
                        review: { enabled: true, label: 'Review Actions', icon: 'âœ…', submodules: [
                          { id: 'approve', name: 'Approve', enabled: true, cost: 'cheap', description: 'Mark as approved', action: 'approve', lastResult: null },
                          { id: 'hold', name: 'Hold for Review', enabled: true, cost: 'cheap', description: 'Manual review needed', action: 'hold', lastResult: null },
                          { id: 'reject', name: 'Reject & Revise', enabled: true, cost: 'cheap', description: 'Send back for revision', action: 'reject', lastResult: null }
                        ]},
                        triggers: { enabled: true, label: 'Post-approval', icon: 'ðŸš€', submodules: [
                          { id: 'news-article', name: 'Create News Article', enabled: false, cost: 'expensive', description: 'Generate related news', lastResult: null },
                          { id: 'competitor-analysis', name: 'Competitor Analysis', enabled: false, cost: 'expensive', description: 'Run competitor pipeline', lastResult: null },
                          { id: 'schedule-refresh', name: 'Schedule Refresh', enabled: false, cost: 'cheap', description: 'Re-run in 30 days', lastResult: null }
                        ]},
                        notifications: { enabled: true, label: 'Notifications', icon: 'ðŸ””', submodules: [
                          { id: 'notify-team', name: 'Notify Team', enabled: true, cost: 'cheap', description: 'Email team members', lastResult: 'ready' },
                          { id: 'slack-notify', name: 'Slack Message', enabled: false, cost: 'cheap', description: 'Post to Slack', lastResult: null },
                          { id: 'webhook-notify', name: 'Webhook', enabled: false, cost: 'cheap', description: 'Call webhook URL', lastResult: null }
                        ]},
                        archive: { enabled: false, label: 'Archive', icon: 'ðŸ“', submodules: [
                          { id: 'archive-sources', name: 'Archive Sources', enabled: false, cost: 'medium', description: 'Save source snapshots', lastResult: null },
                          { id: 'export-bundle', name: 'Export Bundle', enabled: false, cost: 'cheap', description: 'Download all files', lastResult: null },
                          { id: 'create-backup', name: 'Create Backup', enabled: false, cost: 'cheap', description: 'Backup to storage', lastResult: null }
                        ]}
                      },
                      toggleAction(key) { this.actions[key].enabled = !this.actions[key].enabled; },
                      toggleSubmodule(actionKey, subId) {
                        const sub = this.actions[actionKey].submodules.find(s => s.id === subId);
                        if (sub) sub.enabled = !sub.enabled;
                      },
                      selectReview(action) { this.reviewDecision = action; },
                      getEnabledCount(action) { return action.submodules.filter(s => s.enabled).length; },
                      getCostClass(cost) {
                        return { cheap: 'bg-green-100 text-green-700', medium: 'bg-yellow-100 text-yellow-700', expensive: 'bg-orange-100 text-orange-700' }[cost];
                      }
                    }">
                      <div class="bg-rose-50 rounded p-3 border border-rose-200 mb-4">
                        <p class="text-xs text-rose-700 font-medium mb-1">Final Review</p>
                        <p class="text-xs text-gray-600">Make a review decision and configure post-approval triggers. Approved content moves to production; rejected content can be revised.</p>
                      </div>

                      <!-- Quick Review Buttons -->
                      <div class="mb-4">
                        <p class="text-xs text-gray-500 mb-2">Quick Decision</p>
                        <div class="flex gap-2 flex-wrap">
                          <button @click="selectReview('approve')"
                                  :class="reviewDecision === 'approve' ? 'bg-green-100 border-green-500 ring-2 ring-green-200' : 'bg-green-50 border-green-300'"
                                  class="border text-green-700 px-4 py-2 rounded-lg text-sm hover:bg-green-100 transition-all">
                            âœ“ Approve
                          </button>
                          <button @click="selectReview('hold')"
                                  :class="reviewDecision === 'hold' ? 'bg-yellow-100 border-yellow-500 ring-2 ring-yellow-200' : 'bg-yellow-50 border-yellow-300'"
                                  class="border text-yellow-700 px-4 py-2 rounded-lg text-sm hover:bg-yellow-100 transition-all">
                            â¸ Hold for Review
                          </button>
                          <button @click="selectReview('reject')"
                                  :class="reviewDecision === 'reject' ? 'bg-red-100 border-red-500 ring-2 ring-red-200' : 'bg-red-50 border-red-300'"
                                  class="border text-red-700 px-4 py-2 rounded-lg text-sm hover:bg-red-100 transition-all">
                            âœ— Reject & Revise
                          </button>
                        </div>
                      </div>

                      <!-- Feedback -->
                      <div class="mb-4">
                        <label class="block text-xs text-gray-500 mb-1">Feedback / Notes</label>
                        <textarea rows="2" placeholder="Optional notes for the team..." class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></textarea>
                      </div>

                      <!-- Action Cards Grid -->
                      <p class="text-xs text-gray-500 mb-3">Trigger Configuration (click to configure)</p>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <template x-for="(action, key) in actions" :key="key">
                          <div class="rounded-lg border transition-all cursor-pointer"
                               :class="action.enabled ? 'bg-white border-brand-300 shadow-sm' : 'bg-gray-50 border-gray-200 opacity-60'"
                               @click="expandedAction = expandedAction === key ? null : key">
                            <div class="p-3">
                              <div class="flex items-center justify-between mb-2">
                                <span class="text-lg" x-text="action.icon"></span>
                                <button @click.stop="toggleAction(key)"
                                        class="w-8 h-4 rounded-full relative transition-colors"
                                        :class="action.enabled ? 'bg-brand-500' : 'bg-gray-300'">
                                  <span class="absolute top-0.5 w-3 h-3 rounded-full bg-white shadow transition-all"
                                        :class="action.enabled ? 'right-0.5' : 'left-0.5'"></span>
                                </button>
                              </div>
                              <p class="text-sm font-medium text-gray-800" x-text="action.label"></p>
                              <p class="text-[10px] text-gray-500 mt-1">
                                <span x-text="getEnabledCount(action)"></span>/<span x-text="action.submodules.length"></span> active
                              </p>
                            </div>

                            <!-- Expanded Submodule Config -->
                            <div x-show="expandedAction === key" x-transition @click.stop class="border-t border-gray-200 p-3 bg-gray-50">
                              <p class="text-[10px] text-gray-500 mb-2 font-medium uppercase">Options</p>
                              <div class="space-y-2">
                                <template x-for="sub in action.submodules" :key="sub.id">
                                  <div class="flex items-center justify-between bg-white rounded p-2 border cursor-pointer hover:bg-gray-50 transition-colors group"
                                       :class="sub.enabled ? 'border-brand-200' : 'border-gray-200 opacity-60'"
                                       @click="$root.openResultsPanel(sub, action)">
                                    <div class="flex items-center gap-2 min-w-0">
                                      <input type="checkbox" :checked="sub.enabled" @click.stop @change="toggleSubmodule(key, sub.id)"
                                             class="rounded border-gray-300 text-brand-600">
                                      <div class="min-w-0">
                                        <p class="text-xs font-medium text-gray-700 truncate" x-text="sub.name"></p>
                                        <p class="text-[10px] text-gray-400 truncate" x-text="sub.description"></p>
                                      </div>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                                      <span :class="getCostClass(sub.cost)" class="text-[8px] px-1.5 py-0.5 rounded" x-text="sub.cost"></span>
                                      <span x-show="sub.lastResult" class="text-[10px] text-gray-500 group-hover:hidden" x-text="sub.lastResult"></span>
                                      <span class="text-[10px] text-brand-500 hidden group-hover:inline">View â†’</span>
                                    </div>
                                  </div>
                                </template>
                              </div>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Status Summary -->
                      <div class="bg-gray-50 rounded p-3 border border-gray-200">
                        <p class="text-xs text-gray-500 mb-2">Review Status</p>
                        <div class="flex flex-wrap gap-4 text-sm">
                          <span :class="reviewDecision === 'approve' ? 'text-green-600' : reviewDecision === 'hold' ? 'text-yellow-600' : reviewDecision === 'reject' ? 'text-red-600' : 'text-gray-400'">
                            Decision: <span class="font-medium" x-text="reviewDecision ? reviewDecision.charAt(0).toUpperCase() + reviewDecision.slice(1) : 'Pending'"></span>
                          </span>
                          <span class="text-blue-600"><span class="font-medium">2</span> triggers enabled</span>
                          <span class="text-gray-500">Ready to finalize</span>
                        </div>
                      </div>
                    </div>

                  </div>

                  <!-- Step Action Bar (bottom) -->
                  <div class="flex items-center justify-between px-4 py-3 border-t border-gray-200 bg-gray-50">
                    <div class="flex items-center gap-2">
                      <span x-show="!isStepUnlocked(i) && stepStates[i]?.status !== 'completed' && stepStates[i]?.status !== 'skipped'"
                            class="text-xs text-gray-400 italic">Complete previous step first</span>
                      <!-- Warning for Step 1 if no submodules approved -->
                      <span x-show="i === 1 && isStepUnlocked(i) && getTotalApprovedSubmodules() === 0 && stepStates[i]?.status !== 'completed'"
                            class="text-xs text-yellow-600 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                        Approve at least one submodule first
                      </span>
                      <button x-show="stepStates[i]?.status === 'completed' || stepStates[i]?.status === 'skipped'"
                              @click="reopenStep(i)"
                              class="text-gray-500 hover:text-gray-700 px-3 py-1.5 rounded text-xs border border-gray-300 hover:border-gray-400">
                        Reopen
                      </button>
                    </div>
                    <div class="flex items-center gap-2">
                      <!-- Skip Step button -->
                      <button x-show="stepStates[i]?.status !== 'skipped' && stepStates[i]?.status !== 'completed' && isStepUnlocked(i)"
                              @click="skipStep(i)"
                              class="text-gray-500 hover:text-yellow-600 px-3 py-1.5 rounded text-xs border border-gray-300 hover:border-yellow-400">
                        Skip Step
                      </button>
                      <!-- Approve Step button - disabled if Step 1 has no approved submodules -->
                      <button x-show="stepStates[i]?.status !== 'completed' && stepStates[i]?.status !== 'skipped' && isStepUnlocked(i)"
                              @click="markStepCompleted(i)"
                              :disabled="i === 1 && getTotalApprovedSubmodules() === 0"
                              :class="(i === 1 && getTotalApprovedSubmodules() === 0) ? 'bg-gray-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
                              class="text-white px-4 py-1.5 rounded text-xs font-medium shadow-sm">
                        Approve Step
                      </button>
                    </div>
                  </div>

                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- PROJECT LIST -->
        <div x-show="!selectedProject && !showPipelineAccordion">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-lg font-semibold">Projects</h2>
              <p class="text-sm text-gray-500">Create projects with input data and run pipelines</p>
            </div>
            <div class="flex items-center gap-3">
              <input x-model="projectSearchFilter" @input.debounce.200ms="filterProjects()" type="search" placeholder="Filter..."
                class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm text-gray-900 w-40 focus:outline-none focus:border-brand-500">
              <button @click="selectedProject = null; showPipelineAccordion = true; step0Mode = 'new'; step0NewProjectName = ''; step0SelectedProjectId = ''; expandedStep = 0; stepStates = {}; for(let i=0;i<11;i++)stepStates[i]={status:'pending',resultSummary:''}; stepStates[0]={status:'active',resultSummary:''}"
                class="bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg text-sm font-medium">+ New Project</button>
            </div>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm"><p class="text-2xl font-bold text-gray-900" x-text="projects.length"></p><p class="text-xs text-gray-500">Total</p></div>
            <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm"><p class="text-2xl font-bold text-green-600" x-text="projects.filter(p => p.status === 'completed').length"></p><p class="text-xs text-gray-500">Completed</p></div>
            <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm"><p class="text-2xl font-bold text-blue-600" x-text="projects.filter(p => p.status === 'running').length"></p><p class="text-xs text-gray-500">Running</p></div>
            <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm"><p class="text-2xl font-bold text-red-600" x-text="projects.filter(p => p.status === 'failed').length"></p><p class="text-xs text-gray-500">Failed</p></div>
          </div>
          <div class="space-y-2">
            <template x-if="filteredProjects.length === 0">
              <div class="text-center py-12 text-gray-500">
                <p x-show="useMockData">Switch to Live mode to see real projects</p>
                <p x-show="!useMockData">No projects yet. Click "+ New Project" to get started.</p>
              </div>
            </template>
            <template x-for="project in filteredProjects" :key="project.id">
              <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm hover:border-brand-300 transition-all">
                <div class="flex items-center justify-between">
                  <div class="min-w-0 flex-1 cursor-pointer" @click="selectProject(project)">
                    <h3 class="font-medium text-gray-900" x-text="project.name"></h3>
                    <div class="flex items-center gap-2 mt-1">
                      <span x-show="project.label" class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded" x-text="project.label"></span>
                      <span class="text-xs text-gray-500" x-text="(project.input_count || 0) + ' items'"></span>
                      <span class="text-xs text-gray-400" x-text="formatDate(project.created_at)"></span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 flex-shrink-0 ml-4">
                    <span :class="stepStatusBadge(project.status)" class="text-xs px-2 py-0.5 rounded-full" x-text="project.status"></span>
                    <button x-show="project.input_count > 0 && project.status !== 'running'" @click.stop="startProject(project.id)"
                      class="px-3 py-1 bg-brand-600 text-white text-xs rounded hover:bg-brand-700">Run</button>
                    <button @click.stop="deleteProject(project.id)" class="text-gray-400 hover:text-red-600 text-sm">Ã—</button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

      </div>

      <!-- Modal removed - project creation now in Step 0 -->

      <!-- ==================== PIPELINE MONITOR TAB ==================== -->
      <div x-show="activeTab === 'monitor'">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Pipeline Monitor</h2>
          <button @click="loadRuns()" x-show="!useMockData" class="text-sm text-brand-600 hover:text-brand-800">â†» Refresh</button>
        </div>
        <div class="space-y-3">
          <template x-if="runs.length === 0">
            <p class="text-gray-500 text-sm py-8 text-center">No pipeline runs yet.</p>
          </template>
          <template x-for="run in runs" :key="run.id">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
              <div class="p-4 cursor-pointer hover:bg-gray-50" @click="loadRunDetails(run)">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-3">
                    <span class="font-medium text-gray-900" x-text="run.project_name"></span>
                    <span class="text-xs text-gray-500 font-mono" x-text="'#' + (run.id || '').slice(0, 8)"></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span :class="stepStatusBadge(run.status)" class="text-xs px-2 py-0.5 rounded-full" x-text="run.status"></span>
                    <span class="text-gray-400" x-text="run._expanded ? 'â–¼' : 'â–¶'"></span>
                  </div>
                </div>
                <!-- Mock stages (demo mode) -->
                <template x-if="useMockData && run.stages?.length > 0">
                  <div class="grid grid-cols-12 gap-0.5 mb-2">
                    <template x-for="stage in run.stages" :key="stage.stage_index">
                      <div class="group relative">
                        <div :class="stageBarClass(stage.status)" class="h-5 rounded-sm flex items-center justify-center">
                          <span class="text-[9px] font-bold text-white/80" x-text="stage.stage_index"></span>
                        </div>
                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover:block z-10">
                          <div class="bg-gray-900 text-xs text-white px-2 py-1 rounded whitespace-nowrap shadow-lg" x-text="stage.stage_name"></div>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>
                <!-- Live progress bar -->
                <template x-if="!useMockData">
                  <div class="mb-2">
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                      <div class="h-full bg-brand-600 transition-all" :style="'width:' + (run.progress || 0) + '%'"></div>
                    </div>
                  </div>
                </template>
                <div class="flex justify-between text-xs text-gray-500">
                  <span x-show="useMockData" x-text="(run.stages || []).filter(s => s.status === 'completed').length + '/' + (run.stages || []).length + ' steps'"></span>
                  <span x-show="!useMockData" x-text="(run.entities_completed || 0) + '/' + (run.entities_total || 0) + ' entities â€¢ ' + (run.progress || 0) + '%'"></span>
                  <span x-text="run.duration || formatDate(run.started_at)"></span>
                </div>
              </div>
              <!-- Expanded: Entity details -->
              <div x-show="run._expanded && !useMockData" class="border-t border-gray-200 bg-gray-50 px-4 py-3">
                <p x-show="!run.runEntities" class="text-sm text-gray-500">Loading entities...</p>
                <div x-show="run.runEntities" class="space-y-2">
                  <template x-for="re in (run.runEntities || [])" :key="re.id">
                    <div class="bg-white rounded border border-gray-200 overflow-hidden">
                      <div class="flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-gray-50" @click="loadEntityStages(run, re)">
                        <div class="flex items-center gap-2">
                          <span class="text-gray-400" x-text="re._stagesExpanded ? 'â–¼' : 'â–¶'"></span>
                          <span class="font-medium text-sm" x-text="re.entity_name || 'Entity'"></span>
                          <span class="text-xs text-gray-400" x-text="re.entity_type"></span>
                        </div>
                        <div class="flex items-center gap-3">
                          <span class="text-xs text-gray-500" x-text="(re.stages_completed || 0) + '/' + (re.stages_total || 0) + ' stages'"></span>
                          <span :class="stepStatusBadge(re.status)" class="text-xs px-2 py-0.5 rounded-full" x-text="re.status"></span>
                        </div>
                      </div>
                      <!-- Stage details -->
                      <div x-show="re._stagesExpanded" class="border-t border-gray-100 bg-gray-50 px-3 py-2">
                        <template x-for="stage in (re.stages || [])" :key="stage.id">
                          <div class="mb-3 last:mb-0">
                            <div class="flex items-center justify-between mb-1">
                              <div class="flex items-center gap-2">
                                <span class="text-xs font-medium" x-text="'Step ' + stage.stage_index + ': ' + stage.stage_name"></span>
                                <span :class="stepStatusBadge(stage.status)" class="text-[10px] px-1.5 py-0.5 rounded" x-text="stage.status"></span>
                              </div>
                              <div class="flex items-center gap-2 text-[10px] text-gray-500">
                                <span x-show="stage.duration_ms" x-text="stage.duration_ms + 'ms'"></span>
                                <span x-show="stage.worker_id" x-text="stage.worker_id"></span>
                              </div>
                            </div>

                            <!-- Submodule Controls (for discovery stages) -->
                            <div x-show="stage.stage_name === 'discovery' || stage.stage_name === 'Discovery'" class="bg-white rounded border border-gray-200 p-2 mt-1 mb-2">
                              <p class="text-[10px] font-medium text-gray-500 mb-2">Run Submodules:</p>
                              <div class="flex flex-wrap gap-2">
                                <template x-for="subName in ['sitemap', 'navigation', 'seed-expansion']" :key="subName">
                                  <div class="flex items-center gap-1">
                                    <button
                                      @click="runSubmoduleForEntity(re.id, 'discovery', subName)"
                                      :disabled="runningSubmodules[subName + '-' + re.id]"
                                      class="text-[10px] px-2 py-1 rounded border transition-colors"
                                      :class="runningSubmodules[subName + '-' + re.id] ? 'bg-gray-100 text-gray-400' : 'bg-brand-50 text-brand-600 border-brand-200 hover:bg-brand-100'">
                                      <span x-show="!runningSubmodules[subName + '-' + re.id]" x-text="subName"></span>
                                      <span x-show="runningSubmodules[subName + '-' + re.id]">Running...</span>
                                    </button>
                                    <button
                                      x-show="submoduleResults[subName + '-' + re.id]"
                                      @click="viewSubmoduleResults(re.id, subName)"
                                      class="text-[10px] text-brand-600 hover:text-brand-800">
                                      <span x-text="(submoduleResults[subName + '-' + re.id]?.result_count || 0) + ' URLs â†’'"></span>
                                    </button>
                                  </div>
                                </template>
                              </div>
                              <!-- Submodule Results Display -->
                              <div x-show="currentViewingSubmodule && currentViewingSubmodule.runEntityId === re.id" class="mt-3 border-t pt-2">
                                <div class="flex items-center justify-between mb-2">
                                  <span class="text-[10px] font-medium text-gray-700" x-text="'Results: ' + (currentViewingSubmodule?.name || '')"></span>
                                  <div class="flex gap-2">
                                    <button
                                      @click="approveSubmoduleForEntity()"
                                      class="text-[10px] px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600">
                                      Approve All
                                    </button>
                                    <button
                                      @click="rejectSubmoduleForEntity()"
                                      class="text-[10px] px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">
                                      Reject
                                    </button>
                                    <button
                                      @click="currentViewingSubmodule = null"
                                      class="text-[10px] px-2 py-1 bg-gray-200 text-gray-600 rounded hover:bg-gray-300">
                                      Close
                                    </button>
                                  </div>
                                </div>
                                <div class="max-h-40 overflow-y-auto bg-gray-50 rounded p-2">
                                  <template x-for="url in (currentViewingSubmodule?.results || []).slice(0, 20)" :key="url.url">
                                    <div class="text-[10px] text-gray-600 truncate py-0.5" x-text="url.url"></div>
                                  </template>
                                  <p x-show="(currentViewingSubmodule?.results || []).length > 20" class="text-[10px] text-gray-400 mt-1" x-text="'... and ' + ((currentViewingSubmodule?.results || []).length - 20) + ' more'"></p>
                                </div>
                              </div>
                            </div>

                            <!-- Output data -->
                            <div x-show="stage.output_data" class="bg-white rounded border border-gray-200 p-2 mt-1">
                              <p class="text-[10px] font-medium text-gray-500 mb-1">Output:</p>
                              <pre class="text-[10px] text-gray-700 overflow-x-auto whitespace-pre-wrap" x-text="JSON.stringify(stage.output_data, null, 2)"></pre>
                            </div>
                            <!-- Error -->
                            <div x-show="stage.error" class="bg-red-50 rounded border border-red-200 p-2 mt-1">
                              <p class="text-[10px] font-medium text-red-600">Error:</p>
                              <pre class="text-[10px] text-red-700" x-text="stage.error"></pre>
                            </div>
                          </div>
                        </template>
                        <p x-show="!re.stages || re.stages.length === 0" class="text-xs text-gray-500">No stages yet</p>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- ==================== CONTENT LIBRARY TAB ==================== -->
      <div x-show="activeTab === 'library'">
        <h2 class="text-lg font-semibold mb-1">Content Library</h2>
        <p class="text-sm text-gray-500 mb-6">Aggregated view of all content produced across projects</p>
        <!-- Aggregate Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
          <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm"><p class="text-3xl font-bold text-gray-900" x-text="contentStats.total.toLocaleString()"></p><p class="text-xs text-gray-500">Total Items</p></div>
          <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm"><p class="text-3xl font-bold text-green-600" x-text="contentStats.active.toLocaleString()"></p><p class="text-xs text-gray-500">Active</p></div>
          <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm"><p class="text-3xl font-bold text-purple-600" x-text="contentStats.generated.toLocaleString()"></p><p class="text-xs text-gray-500">Generated</p></div>
          <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm"><p class="text-3xl font-bold text-orange-600" x-text="contentStats.filtered.toLocaleString()"></p><p class="text-xs text-gray-500">Filtered Out</p></div>
        </div>
        <!-- Breakdown by type -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
            <h3 class="text-sm font-medium text-gray-700 mb-3">By Content Type</h3>
            <template x-for="t in contentStats.byType" :key="t.type">
              <div class="flex items-center justify-between py-1.5">
                <span class="text-sm text-gray-700" x-text="t.type"></span>
                <div class="flex items-center gap-2">
                  <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden"><div class="h-full bg-brand-500 rounded-full" :style="'width:' + (t.count / contentStats.total * 100) + '%'"></div></div>
                  <span class="text-xs text-gray-500 w-12 text-right" x-text="t.count.toLocaleString()"></span>
                </div>
              </div>
            </template>
          </div>
          <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
            <h3 class="text-sm font-medium text-gray-700 mb-3">By Status</h3>
            <template x-for="s in contentStats.byStatus" :key="s.status">
              <div class="flex items-center justify-between py-1.5">
                <span class="text-sm text-gray-700" x-text="s.status"></span>
                <div class="flex items-center gap-2">
                  <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden"><div class="h-full rounded-full" :class="s.color" :style="'width:' + (s.count / contentStats.total * 100) + '%'"></div></div>
                  <span class="text-xs text-gray-500 w-12 text-right" x-text="s.count.toLocaleString()"></span>
                </div>
              </div>
            </template>
          </div>
        </div>
        <div class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
          <h3 class="text-sm font-medium text-gray-700 mb-3">Recent Activity</h3>
          <div class="space-y-2">
            <template x-for="item in recentContent" :key="item.id">
              <div class="flex items-center justify-between py-1.5 border-b border-gray-100 last:border-0">
                <div class="min-w-0 flex-1">
                  <p class="text-sm text-gray-900 truncate" x-text="item.title"></p>
                  <span class="text-xs text-gray-500" x-text="item.content_type"></span>
                </div>
                <div class="flex items-center gap-2 ml-3">
                  <span x-show="item.quality_score" class="text-xs text-gray-500" x-text="Math.round(item.quality_score * 100) + '%'"></span>
                  <span :class="stepStatusBadge(item.status)" class="text-xs px-2 py-0.5 rounded-full" x-text="item.status"></span>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- ==================== TEMPLATES TAB ==================== -->
      <div x-show="activeTab === 'templates'">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-lg font-semibold">Pipeline Templates</h2>
            <p class="text-sm text-gray-500">Saved step configurations that can be loaded into projects</p>
          </div>
          <button @click="editingTemplate = { name: '', description: '', stages: [{ name: '', operation: '' }] }" class="bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-lg text-sm font-medium">New Template</button>
        </div>
        <div x-show="!editingTemplate" class="space-y-3">
          <template x-for="tpl in templates" :key="tpl.id">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4">
              <div class="flex items-center justify-between mb-2">
                <div><span class="font-medium text-gray-900" x-text="tpl.name"></span><span class="text-xs text-gray-500 ml-2" x-text="tpl.stages.length + ' steps'"></span></div>
                <div class="flex items-center gap-2">
                  <span x-show="tpl.is_active" class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full border border-green-200">Active</span>
                  <span class="text-xs text-gray-500" x-text="'v' + tpl.version"></span>
                </div>
              </div>
              <p x-show="tpl.description" class="text-xs text-gray-500 mb-3" x-text="tpl.description"></p>
              <div class="flex items-center gap-1 overflow-x-auto pb-1">
                <template x-for="(stage, si) in tpl.stages" :key="si">
                  <div class="flex items-center gap-1 flex-shrink-0">
                    <div class="bg-gray-100 rounded px-2 py-1 border border-gray-200"><p class="text-[10px] text-gray-700" x-text="stage.name"></p></div>
                    <span x-show="si < tpl.stages.length - 1" class="text-gray-400 text-xs">&rarr;</span>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>
        <!-- Template Editor -->
        <div x-show="editingTemplate" class="bg-white rounded-lg p-6 border border-gray-200 shadow-sm">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Create Template</h3>
          <form @submit.prevent="saveTemplate()">
            <div class="space-y-3 mb-4">
              <div><label class="block text-xs text-gray-600 mb-1">Name</label><input x-model="editingTemplate.name" type="text" required placeholder="Template name..." class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></div>
              <div><label class="block text-xs text-gray-600 mb-1">Description</label><input x-model="editingTemplate.description" type="text" placeholder="What is this for?" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-gray-900 text-sm"></div>
            </div>
            <p class="text-xs text-gray-600 mb-2">Steps:</p>
            <div class="space-y-2 mb-3">
              <template x-for="(stage, si) in editingTemplate.stages" :key="si">
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-600 w-4" x-text="si+1"></span>
                  <input x-model="stage.name" type="text" placeholder="Step name" class="flex-1 bg-white border border-gray-300 rounded px-2 py-1.5 text-gray-900 text-xs">
                  <input x-model="stage.operation" type="text" placeholder="operation" class="flex-1 bg-white border border-gray-300 rounded px-2 py-1.5 text-gray-900 text-xs font-mono">
                  <button type="button" @click="editingTemplate.stages.splice(si, 1)" x-show="editingTemplate.stages.length > 1" class="text-red-500 text-xs px-1">x</button>
                </div>
              </template>
            </div>
            <button type="button" @click="editingTemplate.stages.push({ name: '', operation: '' })" class="text-brand-400 text-xs mb-4 block">+ Add Step</button>
            <div class="flex justify-end gap-3">
              <button type="button" @click="editingTemplate = null" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-900">Cancel</button>
              <button type="submit" class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-medium">Save</button>
            </div>
          </form>
        </div>
      </div>

    </main>

    <!-- Toast -->
    <div x-show="toast" x-transition class="fixed bottom-6 right-6 bg-white border border-gray-200 rounded-lg px-4 py-3 shadow-xl z-50">
      <p class="text-sm" :class="toast?.type === 'error' ? 'text-red-600' : 'text-green-600'" x-text="toast?.message"></p>
    </div>
  </div>

  <script>
    // 11-Step Pipeline (Steps 0-10)
    const PIPELINE_STEPS = [
      { name: 'Project Setup', short: 'Setup', operation: 'project-setup', description: 'Name your project, select template, and configure settings' },
      { name: 'Discovery', short: 'Discover', operation: 'discovery', description: 'Find URLs via sitemap, navigation, search, and external sources' },
      { name: 'Validation & Dedup', short: 'Validate', operation: 'validation', description: 'Filter by trust, authority, policy compliance, and remove duplicates' },
      { name: 'Content Extraction', short: 'Extract', operation: 'extraction', description: 'Download and parse content from validated URLs' },
      { name: 'Quality Filtering', short: 'Filter', operation: 'filtering', description: 'Language check, relevance scoring, adaptive expansion' },
      { name: 'Analysis', short: 'Analyze', operation: 'analysis', description: 'Classify, tag, extract entities, and analyze content' },
      { name: 'Generation', short: 'Generate', operation: 'generation', description: 'Generate output content via AI (profiles, summaries, etc.)' },
      { name: 'QA & Review', short: 'QA', operation: 'qa', description: 'Fact-check, detect hallucinations, score quality' },
      { name: 'Output Bundling', short: 'Bundle', operation: 'bundling', description: 'Package into markdown, JSON, HTML, or custom formats' },
      { name: 'Distribution', short: 'Distribute', operation: 'distribution', description: 'Publish to CMS, API, file storage, or webhooks' },
      { name: 'Final Review', short: 'Review', operation: 'review', description: 'Final approval, feedback, and downstream triggers' }
    ];

    const MOCK_PROJECTS = [
      { id: 'p-bet-001', name: 'Betsson Group Research', label: 'company-profile', description: 'Generate a comprehensive company profile for Betsson Group.', source: 'https://betsson.com', status: 'completed', created_at: '2025-01-10T09:00:00Z' },
      { id: 'p-leo-002', name: 'LeoVegas Company Profile', label: 'company-profile', description: 'Build a detailed profile for LeoVegas.', source: 'https://leovegas.com', status: 'running', created_at: '2025-01-15T14:30:00Z' },
      { id: 'p-evo-003', name: 'Evolution Gaming Profile', label: 'company-profile', description: 'Profile of Evolution Gaming covering live casino.', source: 'https://evolution.com', status: 'completed', created_at: '2025-01-08T11:00:00Z' },
      { id: 'p-news-004', name: 'UK Gambling Commission Updates', label: 'news', description: 'Track UKGC regulatory announcements.', source: 'https://gamblingcommission.gov.uk', status: 'completed', created_at: '2025-01-12T08:15:00Z' },
      { id: 'p-pod-005', name: 'iGaming Podcast Ep. 47', label: 'podcast', description: 'Transcribe and generate show notes for Ep. 47.', source: 'https://example.com/ep47.mp3', status: 'failed', created_at: '2025-01-18T16:00:00Z' },
      { id: 'p-comp-006', name: 'Nordic Market Landscape', label: 'research', description: 'Competitive analysis of Nordic iGaming players.', source: '', status: 'created', created_at: '2025-01-20T10:00:00Z' },
    ];

    function makeMockStages(completedCount, runningIndex = -1) {
      return PIPELINE_STEPS.map((step, i) => {
        let status = 'pending';
        if (i < completedCount) status = 'completed';
        else if (i === runningIndex) status = 'running';
        return { stage_index: i, stage_name: step.name, status };
      });
    }

    const MOCK_RUNS = [
      { id: 'r-001', project_id: 'p-bet-001', project_name: 'Betsson Group Research', status: 'completed', started_at: '2025-01-10T09:05:00Z', duration: '4m 32s', stages: makeMockStages(12), _expanded: false },
      { id: 'r-002', project_id: 'p-leo-002', project_name: 'LeoVegas Company Profile', status: 'running', started_at: '2025-01-15T14:35:00Z', duration: null, stages: makeMockStages(5, 5), _expanded: false },
      { id: 'r-003', project_id: 'p-evo-003', project_name: 'Evolution Gaming Profile', status: 'completed', started_at: '2025-01-08T11:10:00Z', duration: '5m 11s', stages: makeMockStages(12), _expanded: false },
      { id: 'r-004', project_id: 'p-news-004', project_name: 'UK Gambling Commission Updates', status: 'completed', started_at: '2025-01-12T08:20:00Z', duration: '2m 45s', stages: makeMockStages(12), _expanded: false },
      { id: 'r-005', project_id: 'p-pod-005', project_name: 'iGaming Podcast Ep. 47', status: 'failed', started_at: '2025-01-18T16:05:00Z', duration: '1m 12s', stages: makeMockStages(4, -1), _expanded: false },
    ];

    const MOCK_TEMPLATES = [
      { id: 't-001', name: 'Full Company Profile', description: 'All 11 steps for comprehensive company profiles.', version: 2, is_active: true, stages: PIPELINE_STEPS.map(s => ({ name: s.short, operation: s.operation })) },
      { id: 't-002', name: 'News Digest', description: '8-step pipeline for news article synthesis.', version: 1, is_active: true, stages: [{ name: 'Scope', operation: 'input-scope' }, { name: 'Discover', operation: 'url-discovery' }, { name: 'Validate', operation: 'source-validation' }, { name: 'Extract', operation: 'content-extract' }, { name: 'Filter', operation: 'content-filter' }, { name: 'Generate', operation: 'article-generate' }, { name: 'QA', operation: 'qa-validation' }, { name: 'Bundle', operation: 'output-package' }] },
      { id: 't-003', name: 'Podcast Processing', description: 'Transcribe and generate show notes.', version: 1, is_active: true, stages: [{ name: 'Setup', operation: 'input-scope' }, { name: 'Transcribe', operation: 'audio-transcribe' }, { name: 'Extract', operation: 'content-extract' }, { name: 'Topics', operation: 'topic-extract' }, { name: 'Notes', operation: 'shownotes-generate' }, { name: 'QA', operation: 'qa-validation' }, { name: 'Bundle', operation: 'output-package' }] },
    ];

    function app() {
      return {
        useMockData: true,
        toast: null,
        activeTab: 'projects',
        tabs: [
          { id: 'projects', label: 'Projects' },
          { id: 'monitor', label: 'Pipeline Monitor' },
          { id: 'library', label: 'Content Library' },
          { id: 'templates', label: 'Templates' }
        ],

        // Templates (pipeline configurations)
        pipelineTemplates: [],
        selectedTemplateId: null,

        // Step 0 state (inline project selection)
        step0Mode: 'new', // 'new' or 'existing'
        step0NewProjectName: '',
        step0SelectedProjectId: '',
        showPipelineAccordion: false, // Show accordion even without selectedProject

        // Legacy modal (can be removed)
        showNewProjectModal: false,
        newProjectForm: {
          name: '',
          template_id: '',
          input_text: ''
        },
        pipelineSteps: PIPELINE_STEPS,

        // Projects
        projects: [],
        filteredProjects: [],
        selectedProject: null,
        projectSearchFilter: '',

        // Accordion state
        expandedStep: null,
        stepStates: {},

        // Active run tracking (for approval flow)
        currentRunId: null,
        currentRunEntityId: null,
        currentRunEntityIds: [], // All entity IDs for current run

        // Submodule execution tracking
        runningSubmodules: {},   // { submoduleId: true } or { 'subName-runEntityId': true } while running
        submoduleResults: {},    // { submoduleId: { result_count, results, status, submodule_run_id } }
        currentSubmoduleRun: null, // Currently displayed submodule run in panel
        currentViewingSubmodule: null, // { runEntityId, name, results, submodule_run_id } for inline view

        // Runs
        runs: [],

        // Content stats (aggregated)
        contentStats: { total: 0, active: 0, generated: 0, filtered: 0, byType: [], byStatus: [] },
        recentContent: [],

        // Templates
        templates: [],
        editingTemplate: null,

        // Step 0 additional fields
        step0ProjectDescription: '',
        step0SelectedTemplateId: '',

        // Results Panel (slide-in)
        resultsPanelOpen: false,
        resultsPanel: null,

        // New Submodule Overlay Panel State
        submodulePanelOpen: false,
        activeSubmodule: null,
        activeCategory: null,
        submoduleState: 'idle', // 'idle', 'ready', 'running', 'completed', 'viewing', 'approved'
        submoduleRunResult: null,
        showAdvancedOptions: false,
        showUploadForm: false,
        submoduleInputUrls: '',
        uploadedCsvInfo: null,
        submoduleOptions: {
          // Sitemap options
          sitemap_location: 'auto',
          include_nested: true,
          // Navigation options
          scan_header: true,
          scan_footer: true,
          scan_sidebar: false,
          follow_dropdowns: true,
          // Seed expansion options
          same_domain: true
        },

        // Entity Context (shared across submodules in a step)
        entityContext: null,

        // Discovery Categories and Submodules
        discoveryCategories: {
          website: {
            label: 'Website',
            icon: 'ðŸŒ',
            description: 'Find URLs from company websites',
            enabled: true,
            expanded: false,
            submodules: [
              { id: 'sitemap', name: 'Sitemap', description: 'Parse sitemap.xml to find URLs', cost: 'cheap', status: 'pending', result_count: 0 },
              { id: 'navigation', name: 'Navigation', description: 'Extract links from site navigation', cost: 'cheap', status: 'pending', result_count: 0 },
              { id: 'seed-expansion', name: 'Seed Expansion', description: 'Expand from seed URLs', cost: 'cheap', status: 'pending', result_count: 0 }
            ]
          },
          news: {
            label: 'News',
            icon: 'ðŸ“°',
            description: 'Find news and press releases',
            enabled: false,
            expanded: false,
            submodules: [
              { id: 'rss-feeds', name: 'RSS Feeds', description: 'Parse RSS/Atom feeds', cost: 'cheap', status: 'pending', result_count: 0 },
              { id: 'news-search', name: 'News Search', description: 'Search news APIs', cost: 'medium', status: 'pending', result_count: 0 }
            ]
          },
          linkedin: {
            label: 'LinkedIn',
            icon: 'ðŸ’¼',
            description: 'Company profiles and posts',
            enabled: false,
            expanded: false,
            submodules: [
              { id: 'linkedin-company', name: 'Company Page', description: 'Scrape company profile', cost: 'medium', status: 'pending', result_count: 0 },
              { id: 'linkedin-posts', name: 'Posts', description: 'Fetch recent posts', cost: 'medium', status: 'pending', result_count: 0 }
            ]
          },
          youtube: {
            label: 'YouTube',
            icon: 'ðŸŽ¬',
            description: 'Videos and channel content',
            enabled: false,
            expanded: false,
            submodules: [
              { id: 'youtube-channel', name: 'Channel Videos', description: 'List channel videos', cost: 'cheap', status: 'pending', result_count: 0 },
              { id: 'youtube-search', name: 'YouTube Search', description: 'Search for videos', cost: 'medium', status: 'pending', result_count: 0 }
            ]
          },
          twitter: {
            label: 'Twitter/X',
            icon: 'ðŸ¦',
            description: 'Profile and tweets',
            enabled: false,
            expanded: false,
            submodules: [
              { id: 'twitter-profile', name: 'Profile', description: 'Fetch profile & tweets', cost: 'medium', status: 'pending', result_count: 0 }
            ]
          },
          search: {
            label: 'Search',
            icon: 'ðŸ”',
            description: 'General web search (fallback)',
            enabled: false,
            expanded: false,
            submodules: [
              { id: 'google-search', name: 'Google Search', description: 'General web search', cost: 'expensive', status: 'pending', result_count: 0 }
            ]
          }
        },

        // Open results panel with submodule data (mock mode)
        openResultsPanel(submodule, category) {
          this.currentSubmoduleRun = null; // Clear any previous submodule run
          this.resultsPanel = {
            icon: category?.icon || 'ðŸ“Š',
            title: submodule.name,
            subtitle: `${category?.label || 'Submodule'} â€¢ ${submodule.cost} cost`,
            status: submodule.lastResult ? 'success' : 'pending',
            timestamp: submodule.lastResult ? 'Last run: 2 min ago' : '',
            stats: submodule.lastResult ? {
              result: submodule.lastResult,
              duration: '1.2s',
              cost: submodule.cost === 'cheap' ? '$0.001' : submodule.cost === 'medium' ? '$0.01' : '$0.10'
            } : null,
            items: submodule.lastResult ? this.getMockResultItems(submodule) : [],
            log: null
          };
          this.resultsPanelOpen = true;
        },

        // Run a single submodule (live mode)
        async runSubmodule(type, submoduleId, category) {
          if (!this.currentRunId) {
            this.showToast('Start a run first to execute submodules', 'error');
            return;
          }

          // Get run entity IDs if not already loaded
          if (this.currentRunEntityIds.length === 0) {
            try {
              const res = await fetch(`/api/runs/${this.currentRunId}/entities`);
              const entities = await res.json();
              this.currentRunEntityIds = entities.map(e => e.id);
            } catch (e) {
              this.showToast('Failed to get run entities', 'error');
              return;
            }
          }

          if (this.currentRunEntityIds.length === 0) {
            this.showToast('No entities in this run', 'error');
            return;
          }

          // Mark as running
          this.runningSubmodules[submoduleId] = true;

          try {
            const res = await fetch(`/api/submodules/${type}/${submoduleId}/execute`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                run_id: this.currentRunId,
                run_entity_ids: this.currentRunEntityIds,
                config: {} // Could add config UI here
              })
            });

            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'Execution failed');
            }

            const result = await res.json();

            // Store result
            this.submoduleResults[submoduleId] = {
              result_count: result.result_count,
              results: result.results,
              status: result.status,
              submodule_run_id: result.submodule_run_id,
              duration_ms: result.duration_ms,
              error: result.error
            };

            // Open results panel
            this.openSubmoduleResults({ id: submoduleId, name: submoduleId }, category, type);

            this.showToast(`Found ${result.result_count} results`);
          } catch (e) {
            console.error('Submodule execution failed:', e);
            this.showToast(e.message, 'error');
          } finally {
            this.runningSubmodules[submoduleId] = false;
          }
        },

        // Open results panel for a submodule run
        openSubmoduleResults(submodule, category, type) {
          const result = this.submoduleResults[submodule.id];
          if (!result) {
            this.openResultsPanel(submodule, category);
            return;
          }

          this.currentSubmoduleRun = {
            type,
            submoduleId: submodule.id,
            submodule_run_id: result.submodule_run_id,
            status: result.status
          };

          this.resultsPanel = {
            icon: category?.icon || 'ðŸ“Š',
            title: submodule.name || submodule.id,
            subtitle: `${category?.label || type} â€¢ ${result.result_count} results`,
            status: result.status === 'completed' ? 'success' :
                    result.status === 'approved' ? 'success' :
                    result.status === 'failed' ? 'error' : 'pending',
            timestamp: result.duration_ms ? `Duration: ${result.duration_ms}ms` : '',
            stats: {
              total: result.result_count,
              status: result.status
            },
            items: (result.results || []).slice(0, 100).map(r => ({
              url: r.url,
              title: r.metadata?.title || r.url,
              description: r.metadata?.source || '',
              status: 'success'
            })),
            log: result.error || null
          };
          this.resultsPanelOpen = true;
        },

        // Approve submodule results
        async approveSubmoduleResults() {
          if (!this.currentSubmoduleRun?.submodule_run_id) {
            this.showToast('No submodule run to approve', 'error');
            return;
          }

          try {
            const res = await fetch(`/api/submodules/runs/${this.currentRunId}/${this.currentSubmoduleRun.submodule_run_id}/approve`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({})
            });

            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'Approval failed');
            }

            const result = await res.json();

            // Update local state
            if (this.submoduleResults[this.currentSubmoduleRun.submoduleId]) {
              this.submoduleResults[this.currentSubmoduleRun.submoduleId].status = 'approved';
            }
            this.currentSubmoduleRun.status = 'approved';
            this.resultsPanel.status = 'success';

            this.showToast(`Approved ${result.urls_saved} URLs`);
            this.resultsPanelOpen = false;
          } catch (e) {
            console.error('Approval failed:', e);
            this.showToast(e.message, 'error');
          }
        },

        // Reject submodule results
        async rejectSubmoduleResults() {
          if (!this.currentSubmoduleRun?.submodule_run_id) {
            this.resultsPanelOpen = false;
            return;
          }

          try {
            await fetch(`/api/submodules/runs/${this.currentRunId}/${this.currentSubmoduleRun.submodule_run_id}`, {
              method: 'DELETE'
            });

            // Update local state
            if (this.submoduleResults[this.currentSubmoduleRun.submoduleId]) {
              this.submoduleResults[this.currentSubmoduleRun.submoduleId].status = 'rejected';
            }

            this.showToast('Results rejected');
            this.resultsPanelOpen = false;
          } catch (e) {
            console.error('Rejection failed:', e);
          }
        },

        // Run a submodule for a specific entity (in run details view)
        async runSubmoduleForEntity(runEntityId, type, submoduleName) {
          if (!this.currentRunId) {
            this.showToast('No active run', 'error');
            return;
          }

          const key = `${submoduleName}-${runEntityId}`;
          this.runningSubmodules[key] = true;

          try {
            const res = await fetch(`/api/submodules/${type}/${submoduleName}/execute`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                run_id: this.currentRunId,
                run_entity_ids: [runEntityId]
              })
            });

            const result = await res.json();
            if (!res.ok) throw new Error(result.error || 'Execution failed');

            // Store results
            this.submoduleResults[key] = {
              result_count: result.result_count,
              results: result.results || [],
              status: result.status,
              submodule_run_id: result.submodule_run_id
            };

            this.showToast(`${submoduleName}: ${result.result_count} URLs found`);
          } catch (e) {
            console.error('Submodule execution failed:', e);
            this.showToast(`Failed: ${e.message}`, 'error');
          } finally {
            this.runningSubmodules[key] = false;
          }
        },

        // View submodule results inline
        viewSubmoduleResults(runEntityId, submoduleName) {
          const key = `${submoduleName}-${runEntityId}`;
          const data = this.submoduleResults[key];
          if (!data) return;

          this.currentViewingSubmodule = {
            runEntityId,
            name: submoduleName,
            results: data.results || [],
            submodule_run_id: data.submodule_run_id,
            key
          };
        },

        // Approve submodule results for entity
        async approveSubmoduleForEntity() {
          if (!this.currentViewingSubmodule?.submodule_run_id) return;

          try {
            const res = await fetch(`/api/submodules/runs/${this.currentRunId}/${this.currentViewingSubmodule.submodule_run_id}/approve`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({})
            });

            const result = await res.json();
            if (!res.ok) throw new Error(result.error || 'Approval failed');

            // Update local state
            if (this.submoduleResults[this.currentViewingSubmodule.key]) {
              this.submoduleResults[this.currentViewingSubmodule.key].status = 'approved';
            }

            this.showToast(`Approved: ${result.urls_saved} URLs saved to discovered_urls`);
            this.currentViewingSubmodule = null;
          } catch (e) {
            console.error('Approval failed:', e);
            this.showToast(`Failed: ${e.message}`, 'error');
          }
        },

        // Reject submodule results for entity
        async rejectSubmoduleForEntity() {
          if (!this.currentViewingSubmodule?.submodule_run_id) return;

          try {
            await fetch(`/api/submodules/runs/${this.currentRunId}/${this.currentViewingSubmodule.submodule_run_id}`, {
              method: 'DELETE'
            });

            // Update local state
            if (this.submoduleResults[this.currentViewingSubmodule.key]) {
              this.submoduleResults[this.currentViewingSubmodule.key].status = 'rejected';
            }

            this.showToast('Results rejected');
            this.currentViewingSubmodule = null;
          } catch (e) {
            console.error('Rejection failed:', e);
          }
        },

        // Open results panel with real stage output (live mode)
        async openStageResultsPanel(stageIndex) {
          if (!this.currentRunId) {
            this.showToast('No active run', 'error');
            return;
          }

          try {
            // Fetch stage data from API
            const res = await fetch(`/api/runs/${this.currentRunId}/stages?stage_index=${stageIndex}`);
            if (!res.ok) throw new Error('Failed to fetch stage data');
            const stages = await res.json();

            if (stages.length === 0) {
              this.showToast('No data for this stage yet', 'error');
              return;
            }

            const stage = stages[0]; // Get first entity's stage for now
            const step = this.pipelineSteps[stageIndex];
            const output = stage.output_data || {};

            this.resultsPanel = {
              icon: 'ðŸ“Š',
              title: `Step ${stageIndex}: ${step?.name || stage.stage_name}`,
              subtitle: `${stage.entity_name || 'Entity'} â€¢ ${stage.status}`,
              status: stage.status === 'completed' || stage.status === 'approved' ? 'success' :
                      stage.status === 'failed' ? 'error' :
                      stage.status === 'awaiting_approval' ? 'warning' : 'pending',
              timestamp: stage.completed_at ? `Completed: ${this.formatDate(stage.completed_at)}` :
                         stage.started_at ? `Started: ${this.formatDate(stage.started_at)}` : '',
              stats: {
                total: output.total || output.urls_found || output.pages_scraped || '-',
                duration: stage.duration_ms ? `${stage.duration_ms}ms` : '-',
                status: stage.status
              },
              items: this.extractResultItems(output),
              log: output.log || (stage.error ? JSON.stringify(stage.error, null, 2) : null)
            };
            this.resultsPanelOpen = true;
          } catch (e) {
            console.error('Failed to fetch stage results:', e);
            this.showToast(e.message, 'error');
          }
        },

        // Extract displayable items from stage output_data
        extractResultItems(output) {
          // Handle submodule_results structure (from bullmq_architecture_doc)
          if (output.submodule_results) {
            const items = [];
            for (const [submodule, data] of Object.entries(output.submodule_results)) {
              if (data.items) {
                items.push(...data.items.map(item => ({
                  ...item,
                  title: item.title || item.url || item.name,
                  description: `${submodule}: ${item.description || item.status || ''}`
                })));
              }
            }
            return items.slice(0, 50); // Limit for UI
          }

          // Handle discovered_urls array
          if (output.urls && Array.isArray(output.urls)) {
            return output.urls.slice(0, 50).map(url => ({
              url: typeof url === 'string' ? url : url.url,
              title: typeof url === 'object' ? url.title : null,
              status: 'success'
            }));
          }

          // Handle scraped_pages array
          if (output.pages && Array.isArray(output.pages)) {
            return output.pages.slice(0, 50).map(page => ({
              title: page.title || page.url,
              description: `${page.word_count || 0} words`,
              url: page.url,
              status: 'success'
            }));
          }

          // Handle generic items array
          if (output.items && Array.isArray(output.items)) {
            return output.items.slice(0, 50);
          }

          // Fallback: show raw keys as stats
          return [];
        },

        // Generate mock result items based on submodule type
        getMockResultItems(submodule) {
          const id = submodule.id || submodule.name.toLowerCase().replace(/\s+/g, '-');

          // Discovery submodules
          if (id.includes('sitemap') || id.includes('navigation') || id.includes('seed')) {
            return [
              { url: 'https://example.com/about', status: 'success', title: 'About Page' },
              { url: 'https://example.com/products', status: 'success', title: 'Products' },
              { url: 'https://example.com/team', status: 'success', title: 'Team' },
              { url: 'https://example.com/careers', status: 'success', title: 'Careers' },
            ];
          }

          // Validation submodules
          if (id.includes('domain') || id.includes('trust') || id.includes('authority')) {
            return [
              { title: 'example.com', description: 'DA: 45, Trust: High', status: 'pass' },
              { title: 'blog.example.com', description: 'DA: 32, Trust: Medium', status: 'pass' },
              { title: 'news.spam.com', description: 'DA: 5, Trust: Low', status: 'fail' },
            ];
          }

          // Extraction submodules
          if (id.includes('cheerio') || id.includes('playwright') || id.includes('text')) {
            return [
              { title: 'About Page', description: '1,247 words extracted', status: 'success' },
              { title: 'Products Page', description: '892 words extracted', status: 'success' },
              { title: 'Team Page', description: '456 words extracted', status: 'success' },
            ];
          }

          // Generation submodules
          if (id.includes('gpt') || id.includes('claude') || id.includes('profile')) {
            return [
              { title: 'Company Profile v1', description: 'Generated from 28 sources', status: 'success' },
            ];
          }

          // QA submodules
          if (id.includes('fact') || id.includes('hallucination') || id.includes('structure')) {
            return [
              { title: 'CEO Name', description: 'Verified against LinkedIn', status: 'pass' },
              { title: 'Founded Year', description: 'Confirmed via Crunchbase', status: 'pass' },
              { title: 'Revenue Figure', description: 'No source found', status: 'fail' },
            ];
          }

          // Default
          return [
            { title: 'Result 1', description: 'Processed successfully', status: 'success' },
            { title: 'Result 2', description: 'Processed successfully', status: 'success' },
          ];
        },

        // ==================== DISCOVERY CATEGORY METHODS ====================

        toggleDiscoveryCategory(catKey) {
          // Close all other categories
          Object.keys(this.discoveryCategories).forEach(key => {
            if (key !== catKey) this.discoveryCategories[key].expanded = false;
          });
          // Toggle the clicked category
          this.discoveryCategories[catKey].expanded = !this.discoveryCategories[catKey].expanded;
        },

        getApprovedSubmoduleCount(category) {
          return category.submodules.filter(s => s.status === 'approved').length;
        },

        getCategoryUrlCount(category) {
          return category.submodules
            .filter(s => s.status === 'approved')
            .reduce((sum, s) => sum + (s.result_count || 0), 0);
        },

        getTotalApprovedSubmodules() {
          return Object.values(this.discoveryCategories)
            .flatMap(cat => cat.submodules)
            .filter(s => s.status === 'approved').length;
        },

        getTotalDiscoveredUrls() {
          return Object.values(this.discoveryCategories)
            .flatMap(cat => cat.submodules)
            .filter(s => s.status === 'approved')
            .reduce((sum, s) => sum + (s.result_count || 0), 0);
        },

        // ==================== SUBMODULE OVERLAY PANEL METHODS ====================

        openSubmodule(submodule, category) {
          this.activeSubmodule = submodule;
          this.activeCategory = category;
          this.submodulePanelOpen = true;
          this.showAdvancedOptions = false;
          this.showUploadForm = false;
          this.submoduleInputUrls = '';
          this.uploadedCsvInfo = null;

          // Restore saved results if available
          if (submodule.runResult) {
            this.submoduleRunResult = submodule.runResult;
            this.submoduleState = submodule.status === 'approved' ? 'approved' : 'viewing';
          } else {
            this.submoduleRunResult = null;
            this.submoduleState = submodule.status === 'approved' ? 'approved' :
                                 submodule.status === 'has_results' ? 'completed' : 'idle';
          }

          // Reset options to defaults
          this.submoduleOptions = {
            sitemap_location: 'auto',
            include_nested: true,
            scan_header: true,
            scan_footer: true,
            scan_sidebar: false,
            follow_dropdowns: true,
            same_domain: true
          };

          // Load entity context if available
          this.loadEntityContext();
        },

        closeSubmodulePanel() {
          this.submodulePanelOpen = false;
          this.activeSubmodule = null;
          this.activeCategory = null;
        },

        canRunSubmodule() {
          // Can run if we have entity context or user has entered URLs/uploaded CSV
          return (this.entityContext && this.entityContext.entities?.length > 0) ||
                 this.submoduleInputUrls.trim().length > 0 ||
                 this.uploadedCsvInfo;
        },

        useExistingEntities() {
          this.showUploadForm = false;
          this.submoduleState = 'ready';
        },

        saveUrlsAsEntities() {
          const urls = this.submoduleInputUrls.trim().split('\n').filter(u => u.trim());
          if (urls.length === 0) {
            this.showToast('No URLs entered', 'error');
            return;
          }

          // Convert URLs to entities
          const entities = urls.map((url, idx) => {
            const cleanUrl = url.trim();
            let domain = cleanUrl;
            try {
              const parsed = new URL(cleanUrl.startsWith('http') ? cleanUrl : 'https://' + cleanUrl);
              domain = parsed.hostname;
            } catch {}
            return {
              entity_name: domain,
              website: cleanUrl.startsWith('http') ? cleanUrl : 'https://' + cleanUrl
            };
          });

          // Store in local context
          this.entityContext = {
            entities,
            source_submodule: 'url-paste',
            stats: this.calculateEntityStats(entities)
          };

          this.uploadedCsvInfo = `${entities.length} URLs saved`;
          this.submoduleInputUrls = '';
          this.submoduleState = 'ready';
          this.showToast(`Saved ${entities.length} URLs`);
        },

        async loadEntityContext() {
          if (!this.currentRunId) {
            this.entityContext = null;
            return;
          }
          try {
            const res = await fetch(`/api/runs/${this.currentRunId}/step-context?step_index=1`);
            if (res.ok) {
              this.entityContext = await res.json();
            } else {
              this.entityContext = null;
            }
          } catch (e) {
            console.error('Failed to load entity context:', e);
            this.entityContext = null;
          }
        },

        handleCsvUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = async (e) => {
            const text = e.target.result;
            const entities = this.parseCsvToEntities(text);

            if (entities.length === 0) {
              this.showToast('No valid entities found in CSV', 'error');
              return;
            }

            this.uploadedCsvInfo = `${file.name} (${entities.length} entities)`;

            // Store in local state for immediate use
            this.entityContext = {
              entities,
              source_submodule: this.activeSubmodule?.id || 'csv-upload',
              stats: this.calculateEntityStats(entities)
            };

            // Save to step context API if we have a run
            if (this.currentRunId) {
              try {
                await fetch(`/api/runs/${this.currentRunId}/step-context`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    step_index: 1,
                    entities,
                    source_submodule: this.activeSubmodule?.id || 'csv-upload'
                  })
                });
              } catch (err) {
                console.warn('Failed to save step context:', err);
              }
            }

            this.submoduleState = 'ready';
          };
          reader.readAsText(file);
        },

        parseCsvToEntities(csvText) {
          const lines = csvText.trim().split('\n');
          if (lines.length < 2) return [];

          // Parse header
          const header = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/['"]/g, ''));

          // Map common variations to standard names
          const columnMap = {
            'entity_name': 'entity_name',
            'name': 'entity_name',
            'company': 'entity_name',
            'company_name': 'entity_name',
            'website': 'website',
            'url': 'website',
            'domain': 'website',
            'linkedin': 'linkedin',
            'linkedin_url': 'linkedin',
            'youtube': 'youtube',
            'youtube_url': 'youtube',
            'twitter': 'twitter',
            'twitter_url': 'twitter',
            'category': 'category'
          };

          const entities = [];
          for (let i = 1; i < lines.length; i++) {
            const values = this.parseCsvLine(lines[i]);
            if (values.length === 0) continue;

            const entity = {};
            header.forEach((col, idx) => {
              const standardCol = columnMap[col] || col;
              if (values[idx]) {
                entity[standardCol] = values[idx].trim().replace(/^["']|["']$/g, '');
              }
            });

            // Skip if no entity_name
            if (!entity.entity_name) continue;

            entities.push(entity);
          }

          return entities;
        },

        parseCsvLine(line) {
          const result = [];
          let current = '';
          let inQuotes = false;

          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"' && !inQuotes) {
              inQuotes = true;
            } else if (char === '"' && inQuotes) {
              inQuotes = false;
            } else if (char === ',' && !inQuotes) {
              result.push(current);
              current = '';
            } else {
              current += char;
            }
          }
          result.push(current);
          return result;
        },

        calculateEntityStats(entities) {
          const byColumn = {};
          const columns = new Set();

          for (const entity of entities) {
            for (const [key, value] of Object.entries(entity)) {
              if (value) {
                columns.add(key);
                byColumn[key] = (byColumn[key] || 0) + 1;
              }
            }
          }

          return {
            total: entities.length,
            columns: Array.from(columns),
            by_column: byColumn
          };
        },

        handleCsvDrop(event) {
          const file = event.dataTransfer.files[0];
          if (!file || !file.name.endsWith('.csv')) {
            this.showToast('Please drop a CSV file', 'error');
            return;
          }
          // Simulate the same as file input
          const fakeEvent = { target: { files: [file] } };
          this.handleCsvUpload(fakeEvent);
        },

        useCommonSeeds() {
          // Add common seed paths to the URLs
          const urls = this.submoduleInputUrls.trim().split('\n').filter(u => u.trim());
          const commonPaths = ['/about', '/products', '/services', '/news', '/blog', '/careers', '/contact'];

          const expanded = [];
          urls.forEach(url => {
            try {
              const baseUrl = new URL(url);
              commonPaths.forEach(path => {
                expanded.push(baseUrl.origin + path);
              });
            } catch (e) {
              // Invalid URL, skip
            }
          });

          if (expanded.length > 0) {
            this.submoduleInputUrls = expanded.join('\n');
            this.showToast(`Added ${expanded.length} seed URLs`);
          }
        },

        async runActiveSubmodule() {
          if (!this.activeSubmodule) return;

          this.submoduleState = 'running';

          // Mock execution for demo mode
          if (this.useMockData) {
            await new Promise(resolve => setTimeout(resolve, 1500));

            const mockEntities = [
              { name: 'Betsson', url_count: 89, error: null },
              { name: 'Evolution', url_count: 124, error: null },
              { name: 'LeoVegas', url_count: 67, error: null },
              { name: 'Kindred', url_count: 32, error: null },
              { name: 'BetCorp', url_count: 0, error: 'SITEMAP_NOT_FOUND' }
            ];

            const totalUrls = mockEntities.reduce((sum, e) => sum + e.url_count, 0);

            this.submoduleRunResult = {
              result_count: totalUrls,
              entities: mockEntities,
              sample_urls: [
                'https://betsson.com/about',
                'https://betsson.com/products',
                'https://betsson.com/careers',
                'https://evolution.com/about',
                'https://evolution.com/games',
                'https://evolution.com/live-casino',
                'https://leovegas.com/about-us',
                'https://leovegas.com/sports',
                'https://kindred.com/about',
                'https://kindred.com/brands'
              ],
              errors: mockEntities.filter(e => e.error)
            };

            this.activeSubmodule.status = 'has_results';
            this.activeSubmodule.result_count = totalUrls;
            this.submoduleState = 'completed';
            return;
          }

          // Live API execution
          try {
            // Build entities from context or URL input
            let entities = [];
            if (this.entityContext?.entities?.length > 0) {
              entities = this.entityContext.entities.map((e, idx) => ({
                id: `entity-${idx}`,
                name: e.entity_name,
                website: e.website,
                metadata: { ...e }
              }));
            } else if (this.submoduleInputUrls.trim()) {
              const urls = this.submoduleInputUrls.trim().split('\n').filter(u => u.trim());
              entities = urls.map((url, idx) => {
                try {
                  const fullUrl = url.startsWith('http') ? url : 'https://' + url;
                  const parsed = new URL(fullUrl);
                  return { id: `entity-${idx}`, name: parsed.hostname.replace('www.', ''), website: fullUrl };
                } catch { return null; }
              }).filter(e => e);
            }

            if (entities.length === 0) {
              this.showToast('No valid entities to process', 'error');
              this.submoduleState = 'idle';
              return;
            }

            // Build config from UI options
            const config = {
              include_nested: this.submoduleOptions.include_nested,
              scan_areas: [this.submoduleOptions.scan_header && 'header', this.submoduleOptions.scan_footer && 'footer', this.submoduleOptions.scan_sidebar && 'sidebar'].filter(Boolean),
              same_domain_only: this.submoduleOptions.same_domain
            };

            // Build request body based on mode
            // Preview mode: send entities directly (no database storage)
            // Database mode: send run_id and run_entity_ids (results saved)
            const requestBody = this.currentRunId
              ? {
                  run_id: this.currentRunId,
                  run_entity_ids: this.currentRunEntityIds?.length > 0 ? this.currentRunEntityIds : entities.map(e => e.id),
                  config
                }
              : {
                  entities: entities,
                  config
                };

            const res = await fetch(`/api/submodules/discovery/${this.activeSubmodule.id}/execute`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(requestBody)
            });

            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'Execution failed');
            }

            const result = await res.json();

            // Group results by entity for display
            const groupedEntities = {};
            (result.results || []).forEach(r => {
              const name = r.entity_name || 'Unknown';
              if (!groupedEntities[name]) groupedEntities[name] = { name, url_count: 0, error: null };
              groupedEntities[name].url_count++;
            });

            this.submoduleRunResult = {
              result_count: result.result_count || 0,
              submodule_run_id: result.submodule_run_id,
              preview_mode: result.preview_mode,
              entities: Object.values(groupedEntities),
              all_urls: (result.results || []).map(r => r.url),
              errors: result.results?._errors || []
            };

            // Store results in submodule for persistence
            if (this.activeSubmodule) {
              this.activeSubmodule.runResult = this.submoduleRunResult;
            }

            this.activeSubmodule.status = 'has_results';
            this.activeSubmodule.result_count = result.result_count || 0;
            this.submoduleState = 'completed';
          } catch (e) {
            console.error('Submodule execution failed:', e);
            this.showToast(e.message, 'error');
            this.submoduleState = 'idle';
          }
        },

        async approveSubmoduleRun() {
          if (!this.activeSubmodule) return;

          // Mock approval for demo mode
          if (this.useMockData) {
            this.activeSubmodule.status = 'approved';
            this.submoduleState = 'approved';
            this.showToast(`Approved ${this.submoduleRunResult?.result_count || 0} URLs`);
            return;
          }

          // Live API approval - only works in database mode (not preview)
          try {
            // Preview mode - just mark as approved locally
            if (this.submoduleRunResult?.preview_mode || !this.currentRunId) {
              this.activeSubmodule.status = 'approved';
              this.submoduleState = 'approved';
              this.showToast(`Approved ${this.submoduleRunResult?.result_count || 0} URLs (preview mode - not saved)`);
              return;
            }

            // Database mode - save to backend
            const submoduleRunId = this.submoduleRunResult?.submodule_run_id;
            if (!submoduleRunId) {
              throw new Error('No submodule run ID found');
            }

            const res = await fetch(`/api/submodules/runs/${this.currentRunId}/${submoduleRunId}/approve`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });

            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'Approval failed');
            }

            this.activeSubmodule.status = 'approved';
            this.submoduleState = 'approved';
            this.showToast(`Approved ${this.submoduleRunResult?.result_count || 0} URLs`);
          } catch (e) {
            console.error('Approval failed:', e);
            this.showToast(e.message, 'error');
          }
        },

        rejectSubmoduleRun() {
          if (!this.activeSubmodule) return;

          this.activeSubmodule.status = 'pending';
          this.activeSubmodule.result_count = 0;
          this.submoduleRunResult = null;
          this.submoduleState = 'idle';
          this.showToast('Results rejected');
        },

        // ==================== STEP APPROVAL METHODS ====================

        canApproveStep(stepIndex) {
          // Step 0 just requires a project selected
          if (stepIndex === 0) return !!this.selectedProject;

          // Step 1 (Discovery) requires at least one approved submodule
          if (stepIndex === 1) {
            return this.getTotalApprovedSubmodules() > 0;
          }

          // Other steps: check their specific requirements
          return true;
        },

        getStepApprovalMessage(stepIndex) {
          if (stepIndex === 1 && this.getTotalApprovedSubmodules() === 0) {
            return 'Approve at least one submodule before approving this step';
          }
          return null;
        },

        async init() {
          if (this.useMockData) {
            this.projects = [...MOCK_PROJECTS];
            this.filteredProjects = [...MOCK_PROJECTS];
            this.runs = MOCK_RUNS.map(r => ({ ...r }));
            this.templates = [...MOCK_TEMPLATES];
            this.entities = [];
            this.filteredEntities = [];
            this.contentStats = {
              total: 12847,
              active: 9234,
              generated: 1876,
              filtered: 3613,
              byType: [
                { type: 'Scraped Pages', count: 8945 },
                { type: 'Generated Articles', count: 1876 },
                { type: 'Entities', count: 1523 },
                { type: 'Transcripts', count: 503 },
              ],
              byStatus: [
                { status: 'Active', count: 9234, color: 'bg-green-500' },
                { status: 'Filtered (Step 3)', count: 1842, color: 'bg-orange-500' },
                { status: 'Filtered (Step 5)', count: 1771, color: 'bg-orange-400' },
                { status: 'Superseded', count: 412, color: 'bg-gray-500' },
              ]
            };
            this.recentContent = [
              { id: 'r1', title: 'Betsson Group Company Profile', content_type: 'generated_article', status: 'active', quality_score: 0.95 },
              { id: 'r2', title: 'Evolution Gaming Q4 Results', content_type: 'scraped_page', status: 'active', quality_score: 0.91 },
              { id: 'r3', title: 'UKGC AML Guidelines 2025', content_type: 'scraped_page', status: 'active', quality_score: 0.89 },
              { id: 'r4', title: 'LeoVegas - Responsible Gaming', content_type: 'scraped_page', status: 'active', quality_score: 0.85 },
              { id: 'r5', title: 'Cookie Policy - LeoVegas', content_type: 'scraped_page', status: 'filtered_step5', quality_score: null },
            ];
          } else {
            // Live API mode
            await Promise.all([
              this.loadProjects(),
              this.loadTemplates(),
              this.loadRuns(),
              this.loadContentStats(),
            ]);
            // Templates come from project.config.stages now, use mock for UI
            this.templates = [...MOCK_TEMPLATES];
          }
        },

        async loadProjects() {
          try {
            const res = await fetch('/api/projects');
            const data = await res.json();
            this.projects = data.map(p => ({
              ...p,
              label: p.template_name || p.project_type || 'No template',
              stages: p.stages || [],
              input_count: (p.input_data || []).length,
              _expanded: false,
            }));
            this.filteredProjects = [...this.projects];
          } catch (e) {
            console.error('Failed to load projects:', e);
            this.showToast('Failed to load projects', 'error');
          }
        },

        async loadTemplates() {
          try {
            const res = await fetch('/api/templates');
            const data = await res.json();
            this.pipelineTemplates = data || [];
          } catch (e) {
            console.error('Failed to load templates:', e);
          }
        },

        async loadRuns() {
          try {
            const res = await fetch('/api/runs?limit=50');
            const data = await res.json();
            this.runs = data.map(r => ({
              ...r,
              _expanded: false,
              stages: [], // Will be loaded on expand
            }));
          } catch (e) {
            console.error('Failed to load runs:', e);
            this.showToast('Failed to load runs', 'error');
          }
        },

        async loadContentStats() {
          try {
            const res = await fetch('/api/content/stats/summary');
            const stats = await res.json();
            this.contentStats = {
              total: stats.total || 0,
              active: stats.published || 0,
              generated: stats.total || 0,
              filtered: stats.unpublished || 0,
              byType: Object.entries(stats.by_type || {}).map(([type, count]) => ({ type, count })),
              byStatus: [
                { status: 'Published', count: stats.published || 0, color: 'bg-green-500' },
                { status: 'Unpublished', count: stats.unpublished || 0, color: 'bg-gray-500' },
              ]
            };
            // Load recent content
            const contentRes = await fetch('/api/content?limit=5');
            const contentData = await contentRes.json();
            this.recentContent = (contentData.data || []).map(c => ({
              id: c.id,
              title: c.title || c.entity_name || 'Untitled',
              content_type: c.output_type,
              status: c.published_at ? 'active' : 'pending',
              quality_score: c.quality_score,
            }));
          } catch (e) {
            console.error('Failed to load content stats:', e);
          }
        },

        // Parse input text into items array
        // Format: "Name, URL" per line
        parseInputText(text) {
          return text.split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0)
            .map(line => {
              const parts = line.split(',').map(p => p.trim());
              return {
                name: parts[0] || line,
                url: parts[1] || null
              };
            });
        },

        // Simple project creation - just name, then go to accordion
        async createProjectSimple() {
          try {
            if (!this.newProjectForm.name) {
              this.showToast('Project name is required', 'error');
              return;
            }

            const res = await fetch('/api/projects', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: this.newProjectForm.name,
                project_type: 'company_profile'
              }),
            });

            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'Failed to create project');
            }

            const project = await res.json();
            await this.loadProjects();
            this.showNewProjectModal = false;
            this.newProjectForm = { name: '', template_id: '', input_text: '' };

            // Open the new project in accordion view
            const newProject = this.projects.find(p => p.id === project.id);
            if (newProject) {
              this.selectProject(newProject);
            }
            this.showToast('Project created - add input data in Step 0');
          } catch (e) {
            console.error('Failed to create project:', e);
            this.showToast(e.message, 'error');
          }
        },

        async createProject() {
          try {
            const inputItems = this.parseInputText(this.newProjectForm.input_text);

            if (!this.newProjectForm.name) {
              this.showToast('Project name is required', 'error');
              return;
            }

            const res = await fetch('/api/projects', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: this.newProjectForm.name,
                template_id: this.newProjectForm.template_id || null,
                input_data: inputItems
              }),
            });

            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'Failed to create project');
            }

            await this.loadProjects();
            this.showNewProjectModal = false;
            this.newProjectForm = { name: '', template_id: '', input_text: '' };
            this.showToast('Project created');
          } catch (e) {
            console.error('Failed to create project:', e);
            this.showToast(e.message, 'error');
          }
        },

        async startProject(projectId) {
          try {
            const res = await fetch(`/api/projects/${projectId}/start`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({}), // Auto-mode: uses project's input_data
            });

            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'Failed to start run');
            }

            const run = await res.json();
            // Track the current run for approval flow
            this.currentRunId = run.id;
            this.currentRunEntityId = run.run_entities?.[0]?.id || null;
            this.currentRunEntityIds = (run.run_entities || []).map(e => e.id);
            // Reset submodule tracking for new run
            this.runningSubmodules = {};
            this.submoduleResults = {};
            this.currentSubmoduleRun = null;
            this.showToast(`Run started with ${run.entities_total} items`);
            await this.loadRuns();
            this.activeTab = 'monitor';
          } catch (e) {
            console.error('Failed to start run:', e);
            this.showToast(e.message, 'error');
          }
        },

        async deleteProject(id) {
          if (!confirm('Archive this project?')) return;
          try {
            const res = await fetch(`/api/projects/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to archive');
            await this.loadProjects();
            this.showToast('Project archived');
          } catch (e) {
            this.showToast('Failed to archive project', 'error');
          }
        },

        async loadRunDetails(run) {
          if (run._expanded) {
            run._expanded = false;
            return;
          }
          try {
            const res = await fetch(`/api/runs/${run.id}/entities`);
            const entities = await res.json();
            run.runEntities = entities.map(e => ({ ...e, _stagesExpanded: false, stages: [] }));
            run._expanded = true;
            // Set current run context for submodule operations
            this.currentRunId = run.id;
            this.currentRunEntityIds = entities.map(e => e.id);
            this.currentViewingSubmodule = null;
          } catch (e) {
            console.error('Failed to load run details:', e);
          }
        },

        async loadEntityStages(run, runEntity) {
          if (runEntity._stagesExpanded) {
            runEntity._stagesExpanded = false;
            return;
          }
          try {
            const res = await fetch(`/api/runs/${run.id}/entities/${runEntity.id}`);
            const data = await res.json();
            runEntity.stages = data.stages || [];
            runEntity._stagesExpanded = true;
          } catch (e) {
            console.error('Failed to load entity stages:', e);
            this.showToast('Failed to load stages', 'error');
          }
        },

        // Projects
        filterProjects() {
          if (!this.projectSearchFilter) { this.filteredProjects = [...this.projects]; return; }
          const q = this.projectSearchFilter.toLowerCase();
          this.filteredProjects = this.projects.filter(p => (p.name || '').toLowerCase().includes(q) || (p.label || '').toLowerCase().includes(q) || (p.description || '').toLowerCase().includes(q));
        },

        selectProject(project) {
          this.selectedProject = project;
          this.showPipelineAccordion = true;
          this.expandedStep = 0;

          // Reset discovery submodules to initial state
          this.resetDiscoverySubmodules();

          // Reset entity context
          this.entityContext = null;

          // Initialize step states for this project
          this.stepStates = {};
          for (let i = 0; i < 12; i++) {
            this.stepStates[i] = { status: 'pending', resultSummary: '' };
          }
          // Mock: completed projects have all steps done
          if (project.status === 'completed') {
            for (let i = 0; i < 12; i++) this.stepStates[i].status = 'completed';
          } else if (project.status === 'running') {
            for (let i = 0; i < 5; i++) this.stepStates[i].status = 'completed';
            this.stepStates[5] = { status: 'active', resultSummary: '' };
            this.expandedStep = 5;
          } else if (project.status === 'created') {
            // New/created projects start at Step 0
            this.stepStates[0] = { status: 'active', resultSummary: '' };
            this.expandedStep = 0;
          }
        },

        resetDiscoverySubmodules() {
          // Reset all submodules in all categories to initial state
          for (const category of Object.values(this.discoveryCategories)) {
            for (const submodule of category.submodules) {
              submodule.status = 'pending';
              submodule.result_count = 0;
              submodule.runResult = null;
            }
          }
          // Also reset active submodule results
          this.submoduleRunResult = null;
        },

        startNewProject() {
          const p = { id: 'p-new-' + Date.now(), name: 'Untitled Project', description: '', source: '', label: '', status: 'created', created_at: new Date().toISOString() };
          this.projects.unshift(p);
          this.filterProjects();
          this.selectProject(p);
        },

        // Create project from Step 0 and select it
        async createAndSelectProject() {
          const name = this.step0NewProjectName?.trim();
          if (!name) {
            this.showToast('Please enter a project name', 'error');
            return;
          }
          try {
            let newProject;
            if (this.useMockData) {
              // Demo mode: create mock project locally
              newProject = {
                id: 'p-' + Date.now(),
                name: name,
                label: 'company-profile',
                description: '',
                source: '',
                status: 'created',
                input_count: 0,
                created_at: new Date().toISOString(),
              };
              this.projects.unshift(newProject);
              this.filteredProjects = [...this.projects];
            } else {
              // Live mode: API call
              const res = await fetch('/api/projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, project_type: 'company_profile' }),
              });
              if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error || 'Failed to create project');
              }
              const project = await res.json();
              await this.loadProjects();
              newProject = this.projects.find(p => p.id === project.id);
            }
            this.step0NewProjectName = '';
            if (newProject) {
              this.selectProject(newProject);
              this.showToast('Project created! Add input data in Step 1.');
              // Mark Step 0 complete, move to Step 1
              this.stepStates[0] = { status: 'completed', resultSummary: 'Project created' };
              this.stepStates[1] = { status: 'active', resultSummary: '' };
              this.expandedStep = 1;
            }
          } catch (e) {
            console.error('Failed to create project:', e);
            this.showToast(e.message, 'error');
          }
        },

        // Select project by ID (from Step 0 dropdown)
        selectProjectById(projectId) {
          if (!projectId) return;
          const project = this.projects.find(p => p.id === projectId);
          if (project) {
            this.selectProject(project);
            // Mark Step 0 complete, move to Step 1
            this.stepStates[0] = { status: 'completed', resultSummary: 'Selected: ' + project.name };
            this.stepStates[1] = { status: 'active', resultSummary: '' };
            this.expandedStep = 1;
          }
        },

        // Accordion
        toggleStep(i) {
          this.expandedStep = this.expandedStep === i ? null : i;
        },

        isStepUnlocked(i) {
          if (i === 0) return true;
          const prev = this.stepStates[i - 1];
          return prev?.status === 'completed' || prev?.status === 'skipped';
        },

        async markStepCompleted(i) {
          // In live mode with active run, call approval API
          if (!this.useMockData && this.currentRunId) {
            try {
              const res = await fetch(`/api/runs/${this.currentRunId}/stages/${i}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  run_entity_id: this.currentRunEntityId || undefined,
                  additional_input: {} // Could add UI for additional input here
                })
              });

              if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error || 'Failed to approve stage');
              }

              const result = await res.json();
              this.showToast(`Stage ${i} approved. ${result.approved} entities continuing to stage ${result.next_stage}.`);
            } catch (e) {
              console.error('Failed to approve stage:', e);
              this.showToast(e.message, 'error');
              return;
            }
          }

          // Update local UI state
          this.stepStates[i] = { ...this.stepStates[i], status: 'completed' };
          // Auto-expand next step
          if (i < 11) {
            this.stepStates[i + 1] = { ...this.stepStates[i + 1], status: 'active' };
            this.expandedStep = i + 1;
          }
        },

        skipStep(i) {
          this.stepStates[i] = { ...this.stepStates[i], status: 'skipped' };
          if (i < 11 && this.stepStates[i + 1]?.status === 'pending') {
            this.stepStates[i + 1] = { ...this.stepStates[i + 1], status: 'active' };
            this.expandedStep = i + 1;
          }
        },

        reopenStep(i) {
          this.stepStates[i] = { ...this.stepStates[i], status: 'active' };
          this.expandedStep = i;
        },

        // Templates
        saveTemplate() {
          const stages = this.editingTemplate.stages.map(s => ({ name: s.name, operation: s.operation }));
          this.templates.unshift({ id: 't-new-' + Date.now(), name: this.editingTemplate.name, description: this.editingTemplate.description, version: 1, is_active: true, stages });
          this.editingTemplate = null;
          this.showToast('Template saved');
        },

        // Helpers
        showToast(message, type = 'success') { this.toast = { message, type }; setTimeout(() => { this.toast = null; }, 3000); },
        formatDate(d) { if (!d) return ''; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); },

        stepHeaderClass(status) {
          return ({
            completed: 'bg-green-100 text-green-600 border border-green-200',
            approved: 'bg-green-100 text-green-600 border border-green-200',
            active: 'bg-brand-600 text-white',
            awaiting_approval: 'bg-yellow-100 text-yellow-600 border border-yellow-200',
            skipped: 'bg-gray-100 text-gray-300 border border-gray-200',
            pending: 'bg-gray-100 text-gray-300 border border-gray-200',
          })[status] || 'bg-gray-100 text-gray-300 border border-gray-200';
        },

        stepStatusBadge(status) {
          return ({
            active: 'bg-blue-100 text-blue-700',
            completed: 'bg-green-100 text-green-700',
            approved: 'bg-green-100 text-green-700',
            awaiting_approval: 'bg-yellow-100 text-yellow-700',
            running: 'bg-blue-100 text-blue-700',
            failed: 'bg-red-100 text-red-700',
            skipped: 'bg-gray-100 text-gray-500',
            pending: 'bg-gray-100 text-gray-500',
            created: 'bg-gray-100 text-gray-600',
            filtered_step3: 'bg-orange-100 text-orange-700',
            filtered_step5: 'bg-orange-100 text-orange-700',
          })[status] || 'bg-gray-100 text-gray-600';
        },

        stageBarClass(status) {
          return ({
            completed: 'bg-green-500',
            running: 'bg-blue-500 animate-pulse',
            failed: 'bg-red-500',
            pending: 'bg-gray-200',
          })[status] || 'bg-gray-200';
        },
      };
    }
  </script>
</body>
</html>
